<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <title>demo for nemo</title>
  <style type="text/css">
    body { background-color: #fff; color: #666; text-align: center; font-family: arial, sans-serif; }
    div.dialog {
      width: 25em;
      padding: 0 4em;
      margin: 4em auto 0 auto;
      border: 1px solid #ccc;
      border-right-color: #999;
      border-bottom-color: #999;
    }
    h1 { font-size: 100%; color: #f00; line-height: 1.5em; }
  </style>
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/js/jquery-1.10.2.js"></script>


    <!-- 最新 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="/js/bootstrap.min.js"></script>
    <!--<script src="/js/jquery.timer.js"></script>-->

    <script type="text/javascript" src="/js/jplayer/jquery.jplayer.min.js"></script>
    <script type="text/javascript" src="/js/jquery.pin.js"></script>
    <script src="js/lufylegend-1.9.0.min.js"></script>
    <style>

        .answersection
        {
            padding:5px;
            font-size: 18px;
        }
        .picsection
        {
             padding:5px;

        }

        .picsection img
        {
            width:180px;
            height:180px;
            padding:10px;
        }

        #chinese
        {

            font-size: 18px;
            color:#000000;
        }

        #english{
            font-size: 20px;
            color:#000000;
        }
        .shouldhide
        {
            font-size: 18;
            color:#000000;

        }
        #infodiv
        {
            text-align: left;
        }

        .lilabel
        {
            color:#7dcefd;
            font-size: 22px;
            margin-right: 5px;
        }

        #play
        {
            font-size: 26px;
            padding-left: 8px;
        }
        .preclass
        {
            font-size: 14px;
        }
    </style>
</head>

<script>

    Array.prototype.contains = function(obj) {
        var i = this.length;
        while (i--) {
            if (this[i] === obj) {
                return true;
            }
        }
        return false;
    }
</script>
<script>

    window.qindex = 0;
    var wrongpicsm = "http://baicizhan.qiniudn.com/pack/assets/done-wrong.png";
    var rightpicsm = "http://baicizhan.qiniudn.com/pack/assets/done-right.png";

    var wrongpic = "/html5/picture/nemo1/wrong.jpg";
    var rightpic = "/html5/picture/nemo1/right.jpg";

    /**
     * get quesion according to index
     * @param index
     * @returns {*}
     */
    function getQuesion(index)
    {
        if(index < 0)
            return null;
        var count = 0;
        for(var q in map)
        {
           if(count == index)
           {
               var question = map[q];
               return question;
           }
           count++;
        }

        return null;
    }



/**
 * get size of a map.
 */
function getMapSize(map)
{
    if(map == null || map == undefined)
        return 0;

    var count = 0;
    for(var q in map)
    {
        count++;
    }

    return count;
}

// 0表示单词选图 1表示选图
var CHOOSEPIC = 0;
var CHOOSEWORD = 1;
window.round = CHOOSEWORD;

 /**
  * 获取大于等于0小于等于max的n个数字,除了except
  */
function getRandom(n,except,max)
{
    var array = new Array();
    while(array.length <= n)
    {
        var random = Math.floor(Math.random()*max);
        //如果是except 或者array中已经有了random，那么继续选择
        if(random == except || array.contains(random) > 0)
            continue;

        array.push(random);
    }
    return array;
}

/**
 * 单词选意思
 *
 */
function renderQuestion1(index)
{
    $(".picsection").hide();
    $(".answersection").show();

    //当前问题
    var q  = getQuesion(index);

    //如果是最后一个 就...
    if(q == null || q == undefined)
    {
        window.qindex = 0;
        for(var key in dmap)
        {
            dmap[key].clear();
        }

        $("#left").hide(500);
        //$("#left").hide();
        //initbglayer();
        initBubbleLayer();
        treeLayer.graphics.clear();
        //initTree(treeRoot);
        initLeft();
        initusertipsLayer();
        showmodalPanel(step1ok);
        return;
    }

    //上一个问题
    var preq = getQuesion(index-1);

    $("#english").text(q.word);
    //播放声音
    playaudio(q.audio);

    if(preq == null )
    {
        $(".preclass").hide();
    }
    else
    {
        $(".preclass").show();
        $("#preword").text(preq.word);
        $("#prechinese").text(preq.chinese);
    }

    $("#chinese").text(q.chinese);
    $("#wiki").text(q.wiki);
    $("#next").hide();
    $(".shouldhide").hide();

    $("#qpic").find("img").attr("src","picture/universe/"+ q.pic);


    //填答案
    var mapsize = getMapSize(map);
    //随机生成干扰问题的下标数组
    var interuptArray = getRandom(2,index,mapsize);
    //随机生成正确答案的位置
    var insertPostion = (index+Math.floor(Math.random()*100))%3;
    interuptArray.splice(insertPostion,0,index);

    //开始填答案
    for(var i = 0 ; i < interuptArray.length; i++)
    {
        var qi  = interuptArray[i];
        var question = getQuesion(qi);
        var $word = $("#word"+i)
        $word.text(question.chinese);

        var cls = "wrong";
        var tippic = wrongpicsm;
        if(qi == index)
        {
            cls = " right";
            tippic = rightpicsm;
        }

        $word.attr("class",cls);

        var $img = $word.parent().find("img");
        $img.attr("src",tippic);
        $img.hide();
    }



    $(".right").unbind("click");
    $(".wrong").unbind("click");
    $("#next").unbind("click");
    $(".right").on("click",function(){
        //alert($(this).attr("src"));
        //钩钩图片效果
        //$(".shouldhide").show();
        //show next button
        $("#next").show(500);
        var $img = $(this).parent().find("img");
        $img.show(200)
        $img.hide(200);
    });

    //叉叉图片效果
    $(".wrong").on("click",function(){
        //$(".shouldhide").show();
        var $img = $(this).parent().find("img");
        $img.show(200)
        $img.hide(200);
    });

    $("#next").on("click",function(){
        window.qindex+=1;
        //alert("wright");
        renderQuestion1(window.qindex);

    });

    var audio = q.audio;
    $("#play").on("mouseover",function(){
        $(this).attr("class","glyphicon glyphicon-volume-up");
        playaudio(audio);
    }).on("mouseout",function(){
        $(this).attr("class","glyphicon glyphicon-volume-down");

    });

}

/**
 * 单词炫图
 * @param index
 */
function renderQuestion(index)
{
    $(".picsection").show();
    $(".answersection").hide();

    //文件编号
    var array = [1,2,3,4];
    var q  = getQuesion(index);
    var preq = getQuesion(index-1);

    //如果是最后一个 就...
    if(q == null || q == undefined)
    {
        window.qindex = 0;
        renderQuestion1(0);
        showmodalPanel(step2beginword);

       return;
    }

    $("#english").text(q.word);
    //播放声音
    playaudio(q.audio);

    if(preq == null )
    {
        $(".preclass").hide();
    }
    else
    {
        $(".preclass").show();
        $("#preword").text(preq.word);
        $("#prechinese").text(preq.chinese);
    }

    $("#chinese").text(q.chinese);
    $("#wiki").text(q.wiki);
    $("#next").hide();
    $(".shouldhide").hide();

    //打文件 将第一个(正确答案)于random
    var random = Math.floor(Math.random()*10)%4;
    var tmp = array[random];
    array[random] = array[0];
    array[0] = tmp;

    var count = 1;
    for(var i = 0; i < array.length; i++)
    {
        var picnum = array[i];
        var picid = "pic" + count;
        $("#" + picid).attr("src", "picture/universe/U" + (index + 1) + "" + picnum + ".jpg");

        // 添加class给每一个图片 正确的class石right 错误的石wrong
        var cls = $("#" + picid).attr("class");
        if(cls == null || cls == "undefined")
            cls = "";
        if(picnum == 1)
            cls = " right";
        else
            cls = " wrong";

        $("#" + picid).attr("class",cls);
        count++;
    }

    $(".right").unbind("click");
    $(".wrong").unbind("click");
    $("#next").unbind("click");
    $(".right").on("click",function(){
        //alert($(this).attr("src"));
        //钩钩图片效果
        $(".shouldhide").show();
        //show next button
        $("#next").show(500);

        var originpic = $(this).attr("src");
        $(this).attr("picselected",originpic);
        $(this).attr("jihao","jihao");
        $(this).attr("src",rightpic);
        setTimeout(function(){
            var $img = $("img[jihao='jihao']");
            $img.attr("src",originpic);
            $img.attr("jihao","");

        },500);

    });

    //叉叉图片效果
    $(".wrong").on("click",function(){
        $(".shouldhide").show();
        var originpic = $(this).attr("src");
        $(this).attr("picselected",originpic);
        $(this).attr("jihao","jihao");
        $(this).attr("src",wrongpic);

        setTimeout(function(){
           var $img = $("img[jihao='jihao']");
           $img.attr("src",originpic);
            $img.attr("jihao","");

        },500);
    });

    $("#next").on("click",function(){

        //点亮右边的东西;
        var q = getQuesion(window.qindex);
        var key = q.word;
        var d = dmap[key];
        d.draw();
        $("#left").hide(100);
        $("body").scrollLeft(250);
        window.qindex+=1;
        setTimeout(function(){$("#left").show(500);
            $("body").scrollLeft(0);
            renderQuestion(window.qindex);
        },
        1200);

    });

    var audio = q.audio;
    $("#play").on("mouseover",function(){
        $(this).attr("class","glyphicon glyphicon-volume-up");
        playaudio(audio);
    }).on("mouseout",function(){
        $(this).attr("class","glyphicon glyphicon-volume-down");

    });


}
setTimeout(function() {
    renderQuestion(0);
},200);


var step1ok = "恭喜您！通过了第一关的测试！下一关，我们要把学过知识拼成知识图谱，<br>请根据提示，从左边的卡片中选择一个，用鼠标点击，放到左边的十字架中。"
var step2beginword = "下面我们来复习一下学过的单词";
var step2ok = "恭喜您！将孤立的知识链接成了知识图谱！放个 ~人工烟花~~";
function showmodalPanel(text)
{
    $("#modaltext").html(text);
    $('#myModal').modal('show');
}

</script>

<body>
  <div id="jquery_jplayer_1"></div>
  <div class="container-fluid" id="container">
      <div class="modal fade" id="myModal" tabindex="-1" role="dialog"
           aria-labelledby="myModalLabel" aria-hidden="true">
          <div class="modal-dialog">
              <div class="modal-content">
                  <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal"
                              aria-hidden="true">×
                      </button>
                      <!--<h4 class="modal-title" id="myModalLabel">-->
                          <!--模态框（Modal）标题-->
                      <!--</h4>-->
                  </div>
                  <div class="modal-body" id="modaltext">
                     恭喜您！通过了第一关的测试！下一关，我们要把学过知识拼成知识图谱，<br>
                     请根据提示，从左边的卡片中选择一个，用鼠标点击，放到左边的十字架中。
                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn btn-default"
                              data-dismiss="modal">
                          关闭
                      </button>

                  </div>
              </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
      </div><!-- /.modal -->


      <div class="col-md-4" id="left" style="display:none">
        <div class="col-md-12 panel panel-default">
            <div class="panel-body">
                <div class="col-md-12" id="infodiv">
                    <ul class="list-group">
                        <li class="list-group-item preclass" >
                            <div class="preclass">
                                <span class="">previously:</span>
                                <span class="" id="preword"></span>
                                <span class="" id="prechinese"></span>
                            </div>
                        </li>

                        <li class="list-group-item" >
                            <span class="lilabel "></span>
                            <span class="" id="english" class="">Jupiter</span>
                            <span id="play" class="glyphicon glyphicon-volume-down"></span>
                        </li>
                        <li class="list-group-item"  id="qpic" style="display:none">
                            <a href="#" class="thumbnail"><img src="" /></a>
                        </li>
                        <li class="list-group-item "><span class="lilabel"></span><span class="" id="wiki">Jupiter is the largest planet in solar system.</span></li>
                        <li class="list-group-item shouldhide" ><span class="lilabel "></span> <span class="" id="chinese">木星</span></li>
                        <li class="list-group-item " id="next"><span class="btn btn-default" >next one >> </span></li>
                    </ul>
                </div>

                <div class="col-md-12 picsection" >
                    <div class="col-md-6 image"><a href="#" class="thumbnail"><img src="" id="pic1"/></a></div>
                    <div class="col-md-6  image"><a href="#" class="thumbnail"><img src="" id="pic2"/></a></div>
                    <div class="col-md-6  image"><a href="#" class="thumbnail"><img src="" id="pic3" /></a></div>
                    <div class="col-md-6  image"><a href="#" class="thumbnail"><img src="" id="pic4"/></a></div>
                </div>

                <div class="col-md-12 answersection" style="display: none">
                    <ul class="list-group">
                        <li class="list-group-item ">
                            <div id="word0" class=""></div>
                                <img src="">
                        </li>
                        <li class="list-group-item ">
                            <div id="word1"></div>

                                <img src="">

                        </li>
                        <li class="list-group-item ">
                            <div id="word2" class=""></div>

                                <img src="">
                        </li>
                        <li class="list-group-item">
                            <div id="word3" class=""></div>
                                <img src="">
                        </li>

                    </ul>
                </div>
            </div>
        </div>
      </div>

      <div class="col-md-8">
              <div id="legend">
              </div>

      </div>
  </div>
</body>
</html>

<script>

    function playaudio(audioname) {
        //var paused = $('#jquery_jplayer_1').data().jPlayer.status.paused;
        //if (paused == true)
        $("#jquery_jplayer_1").jPlayer("setMedia", {
            title: "Bubble",
            mp3: audioname
        }).jPlayer("play"); //在页面load播放的时候自动播放
    }

    function loadaudio(audioname) {
        $("#jquery_jplayer_1").jPlayer({
            ready: function() {
                $(this).jPlayer("setMedia", {
                    title: "Bubble"
                }).jPlayer("play"); //在页面load播放的时候自动播放

            },
            swfPath: "/js/jplayer",
            supplied: "mp3",
            wmode: "window",
            smoothPlayBar: true,
            keyEnabled: true,
            remainingDuration: true,
            toggleDuration: true
        });
    }

    loadaudio("");
</script>

<script>
    /**
     * layer is the layer of
     */
    function Drawable(layer,x,y,width,height,key)
    {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.layer = layer;
        this.key = key;
        this.pic = null;
        this.bg = null;
        this.word = null;
        this.wiki = null;
        this.chinese = null;
        this.voice = null;
    }

    Drawable.prototype = {
        drawbg1:function()
        {
            if(this.bg == null)
            {
                var img = new Image();
                img.src = "picture/nemo1/selected2.png";
                var bg = new LBitmap(new LBitmapData(img));
                bg.x = this.x;
                bg.y = this.y;
                this.bg = bg;
                this.layer.addChild(this.bg);
            }
        }
        ,
        drawbg:function()
        {
            if(this.bg == null)
            {
                var img = new Image();
                img.src = "picture/nemo1/bg.png";
                var bg = new LBitmap(new LBitmapData(img));
                bg.x = this.x;
                bg.y = this.y;
                this.bg = bg;
                this.layer.addChild(this.bg);
            }
        }
        ,
        drawdata:function()
        {
            var span = 30;
            var q = map[this.key];
            if (this.pic == null)
            {
                // picture
                var img = new Image();
                img.src = "picture/"+ q.picmd;
                var pic = new LBitmap(new LBitmapData(img));
                span = (this.width - pic.getWidth()) / 2;
                pic.x = this.x + span;
                pic.y = this.y + span;
                this.pic = pic;
                this.layer.addChild(this.pic);
            }

            // word
            //var q = map[this.key];
            if(this.word == null) {
                var textfield = new LTextField();
                this.word = textfield;
                this.word.width = this.bg.getWidth()*5/6;
                this.word.setWordWrap(true);
                this.word.size = 12;
                this.word.color="#3c3c3c";
                this.word.text = breakSendence(q.word,14);
                this.word.x = this.x + span;
                this.word.y = this.y + span + this.pic.getHeight()+5;
                this.layer.addChild(textfield);
            }

            // chinese
            //var q = map[this.key];
            if(this.chinese == null) {
                var textfield = new LTextField();
                this.chinese = textfield;
                this.chinese.size = 10;
                this.chinese.color="#3c3c3c";
                this.chinese.text = q.chinese;
                this.chinese.x = this.x + span+2 ;
                this.chinese.y = this.y + span + this.pic.getHeight()+this.word.getHeight()+10;
                this.layer.addChild(textfield);
            }
        }
        ,
        draw:function() {
            // this.layer.graphics.drawRect(1,"#000000",[this.x,this.y,this.width,this.height]);
            // background picture
            this.clear();
            this.drawbg();
            this.drawdata();

        },

        heart:function()
        {
            var hx = this.x + this.width/2;
            var hy = this.y + this.height/2;

            return [hx,hy];
        },

        within:function(px,py)
        {
            if(px <= this.x+this.width && px >= this.x && py <= this.y+this.height && py >= this.y)
            {
                return true;
            }
            return false;
        }
        ,clear:function()
        {
            if(this.pic != null)
                this.layer.removeChild(this.pic);
            if(this.bg != null)
                this.layer.removeChild(this.bg);
            if(this.word != null)
                this.layer.removeChild(this.word);
            if(this.word != null)
                this.layer.removeChild(this.chinese);
            this.pic = null;
            this.bg = null;
            this.word = null;
            this.chinese = null;
        }
    }
</script>

<script>
    /**
     * layer is the layer of
     */
    function LDrawable(layer,x,y,width,height,key)
    {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.layer = layer;
        this.key = key;
        this.pic = null;
        this.bg = null;
        this.word = null;
        this.word1 = null;
        this.wiki = null;
        this.chinese = null;
        this.voice = null;
    }

    LDrawable.prototype = {
        drawbg:function()
        {
            if(this.bg == null)
            {
                var img = new Image();
                img.src = "picture/nemo1/selected.png";
                var bg = new LBitmap(new LBitmapData(img));
                bg.x = this.x;
                bg.y = this.y;
                this.bg = bg;
                this.layer.addChild(this.bg);
            }
        }
        ,
       changebghover:function()
       {
           if(this.bg != null)
           {
               var img = new Image();
               img.src = "picture/nemo1/hover.png";
               var hover = new LBitmapData(img);
               this.bg.bitmapData = hover;

           }
       }
        ,
        changebgnormal:function()
        {
            if(this.bg != null)
            {
                var img = new Image();
                img.src = "picture/nemo1/selected.png";
                var normal = new LBitmapData(img);
                this.bg.bitmapData = normal;

            }
        }

        ,
        drawdata:function()
        {
            var span = 4;
            var q = map[this.key];
            if (this.pic == null)
            {
                // picture
                var img = new Image();
                img.src = "picture/"+ q.picsm;
                var pic = new LBitmap(new LBitmapData(img));
                span = (this.height-pic.getHeight()) / 2;
                pic.x = this.x + span;
                pic.y = this.y + span;
                this.pic = pic;
                this.layer.addChild(this.pic);
            }

            // word
            //var q = map[this.key];
            if(this.word == null) {
                var textfield = new LTextField();
                this.word = textfield;
                this.word.text = q.chinese;
                this.word.x = this.x + span+this.pic.getWidth()+10;
                this.word.y = this.y + span/2;
                this.layer.addChild(this.word);
            }

            // word
            //var q = map[this.key];
            if(this.word1 == null) {
                var textfield = new LTextField();

                this.word1 = textfield;
                this.word1.size =12;
                this.word1.color = "#3c3c3c";
                this.word1.text = q.word;
                this.word1.x = this.x + span+this.pic.getWidth()+10;
                this.word1.y = this.y + span/2+20;
                this.layer.addChild(this.word1);
            }
        }
        ,
        draw:function() {
            // this.layer.graphics.drawRect(1,"#000000",[this.x,this.y,this.width,this.height]);
            // background picture
            this.drawbg();
            this.drawdata();

        },

        heart:function()
        {
            var hx = this.x + this.width/2;
            var hy = this.y + this.height/2;

            return [hx,hy];
        },

        within:function(px,py)
        {
            if(px <= this.x+this.width && px >= this.x && py <= this.y+this.height && py >= this.y)
            {
                return true;
            }
            return false;
        },

        clear:function()
        {
            if(this.pic != null)
                this.layer.removeChild(this.pic);
            if(this.bg != null)
                this.layer.removeChild(this.bg);
            if(this.word != null)
                this.layer.removeChild(this.word);
            if(this.word1 != null)
                this.layer.removeChild(this.word1);


            this.pic = null;
            this.bg = null;
            this.word = null;
            this.word1 = null;
        }
    }
</script>

<script>

    function getNodes(pairs)
    {
        var nodes = [];

        for(var i = 0; i < pairs.length; i++)
        {
            var r = pairs[i];
            if(nodes.indexOf(r[0]) < 0)
                nodes.push(r[0]);
            if(nodes.indexOf(r[1]) < 0)
                nodes.push(r[1]);
        }

        return nodes;
    }
    function getHierarchy(pairs,root)
    {
        var nodes = getNodes(pairs);
        var layers = [];
        layers.push([root]);
        var nodecount = 1;
        var layercount = 0;
        while(nodecount <= nodes.length)
        {
            var prelayer = layers[layercount];

            var currentlayer = [];
            for(var i = 0; i < prelayer.length; i++)
            {
                var tmp = prelayer[i];
                var children = findChildren(pairs,tmp);
                addArray2Array(children, currentlayer);
                nodecount+=children.length;

            }

            layers.push(currentlayer);

            if(layercount>10)
                break;
            layercount+=1;
        }
        return layers;

    }


    function renderTree(pairs,hs,layer)
    {
        drawableMap = {};
        var count = 1;
        for(var i = 0; i < hs.length; i++)
        {
            var h = hs[i];
            for(var j = 0; j < h.length; j++)
            {
                var d = new Drawable(layer, i*(bgwidth+bgwidth)+10,j*(bgheight+bgheight/4)+10,bgwidth,bgheight,h[j]);
                d.drawbg1();
                drawableMap[h[j]] = d;

                count++;
            }
        }

        return drawableMap;
    }

    /**
     * find children of elem
     * @param pair
     * @param elem
     */
    function findChildren(pairs,elem)
    {
        var children = [];
        for(var i = 0; i < pairs.length; i++)
        {
            var pair = pairs[i];
            if(pair[0] == elem)
                children.push(pair[1])
        }

        return children;
    }

    function addArray2Array(array1,array2)
    {
        if (array1 == null || array1.length == 0)
            return ;

        for(var i = 0; i < array1.length; i++)
        {
            if(array2.indexOf(array1[i]) < 0)
            {
                array2.push(array1[i]);
            }
        }
    }

    /**
     * 用线将将两个drawable连起来。
     * @param d1
     * @param d2
     */
    function link2drawable(layer,d1,d2)
    {
        if(d1 == null || d2 == null)
            return ;
        var p1heart = d1.heart();
        var p2heart = d2.heart();

        p1x = p1heart[0]+d1.width/2;
        p1y = p1heart[1];

        p2x = p2heart[0]-d2.width/2;
        p2y = p2heart[1];

        p3x = p1x+(p2x - p1x)/2;

        layer.graphics.drawLine(0.5,"#7ecefd",[p1x,p1y,p3x,p1y]);
        layer.graphics.drawLine(0.5,"#7ecefd",[p3x,p1y,p3x,p2y]);
        layer.graphics.drawLine(0.5,"#7ecefd",[p3x,p2y,p2x,p2y]);
        return [p3x,(p1y+p2y)/2]
    }

    /**
     * 用线将将两个drawable连起来。
     * @param d1
     * @param d2
     */
    function link2drawable1(layer,d1,d2)
    {
        if(d1 == null || d2 == null)
            return ;
        var p1heart = d1.heart();
        var p2heart = d2.heart();

        p1x = p1heart[0]+d1.width/2;
        p1y = p1heart[1];

        p2x = p2heart[0]-d2.width/2;
        p2y = p2heart[1];

        p3x = p1x+(p2x - p1x)/2;

        layer.graphics.drawLine(0.5,"#7ecefd",[p1x,p1y,p3x,p1y]);
        layer.graphics.drawLine(0.5,"#7ecefd",[p3x,p1y,p3x,p2y]);
        layer.graphics.drawLine(0.5,"#7ecefd",[p3x,p2y,p2x,p2y]);

        return [p3x,(p1y+p2y)/2]
    }

    function linkTree(layer,drawablemap,nodes,pairs)
    {
        for(var i = 0; i < nodes.length; i++)
        {
            var node = nodes[i];
            var drawable1 = drawablemap[node];
            var children = findChildren(pairs,node);
            for(var j = 0; j < children.length; j++)
            {
                var cnode = children[j];
                var drawable2 = drawablemap[cnode];
                link2drawable(layer,drawable1,drawable2);
            }
        }
    }

</script>

<script>
    var pairs =[
        ["Bigbang","Universe","What does big bang create?"],
        ["Universe","Galaxy","What is made of millions of stars,gas and dust?"],
        ["Galaxy","Elliptical galaxy","What galaxy is oval in shape?"],
        ["Galaxy","Spiral galaxy","What galaxy is shaped like a giant whirlpool?"],
        ["Spiral galaxy","Andromeda galaxy","Which galaxy is the largest spiral galaxy?"],
        ["Spiral galaxy","Milky Way galaxy","Which galaxy looks like a band of light observed from earth?"],
        ["Milky Way galaxy","Solar system","What is made up of the sun surrounded by planets and other objects?"],
        ["Milky Way galaxy","Star","What can give off heat and light in the galaxy?"]
    ];

    //节点之间的线 关系
    var relationship = {};
    for(var i = 0; i < pairs.length; i++)
    {
        var pair = pairs[i];
        relationship[pair[0]+pair[1]] = pair[2];
    }

</script>




<script>

var map = {
    "Bigbang": {
        word: "Bigbang",
        audio:"/audio/bigbang.mp3",
        pic: "U11.jpg",
        picmd: "U11md.jpg",
        picsm: "U11sm.jpg",
        wiki: "The universe began with an explosion, the explosion is called the big bang.",
        chinese: "宇宙大爆炸"
    },
    "Universe": {
        word: "Universe",
        audio:"/audio/universe.mp3",
        pic: "U21.jpg",
        picmd: "U21md.jpg",
        picsm: "U21sm.jpg",
        wiki: "The Universe contains earth, planets, stars and everything else in outer space. ",
        chinese: "宇宙"
    },
    "Galaxy": {
        word: "Galaxy",
        audio:"/audio/galaxy.mp3",
        pic: "U31.jpg",
        picmd: "U31md.jpg",
        picsm: "U31sm.jpg",
        wiki: "A galaxy is made up of billions of stars, gas and dust.",
        chinese: "星系"
    },
    "Elliptical galaxy": {
        word: "Elliptical galaxy",
        audio:"/audio/elliptical_galaxy.mp3",
        pic: "U41.jpg",
        picmd: "U41md.jpg",
        picsm: "U41sm.jpg",
        wiki: "An elliptical galaxy is oval or round in shape.",
        chinese: "椭圆星系"
    },
    "Spiral galaxy": {
        word: "Spiral galaxy",
        audio:"/audio/spiral_galaxy.mp3",
        pic: "U51.jpg",
        picmd: "U51md.jpg",
        picsm: "U51sm.jpg",
        wiki: "A spiral galaxy is shaped like a giant whirlpool or pinwheel.",
        chinese: "螺旋星系"
    },
    "Andromeda galaxy": {
        word: "Andromeda galaxy",
        audio:"/audio/andromeda_galaxy.mp3",
        pic: "U61.jpg",
        picmd: "U61md.jpg",
        picsm: "U61sm.jpg",
        wiki: "Andromeda galaxy is a large spiral galaxy.",//，it is indicated to collide with Milky Way galaxy to form an elliptical galaxy
        chinese: "仙女座星系"
    },
    "Milky Way galaxy": {
        word: "Milky Way galaxy",
        audio:"/audio/milky_way_galaxy.mp3",
        pic: "U71.jpg",
        picmd: "U71md.jpg",
        picsm: "U71sm.jpg",
        wiki: "Milky Way galaxy is a spiral galaxy, on earth, it looks like a band of light.",
        chinese: "银河系"
    },
    "Solar system": {
        word: "Solar system",
        audio:"/audio/solar_system.mp3",
        pic: "U81.jpg",
        picmd: "U81md.jpg",
        picsm: "U81sm.jpg",
        wiki: "The sun and surrounding planets make up the solar system. It's a place we called home in the Milk Way Galaxy.",
        chinese: "太阳系"
    },
    "Star": {
        word: "Star",
        audio:"/audio/star.mp3",
        pic: "U91.jpg",
        picmd: "U91md.jpg",
        picsm: "U91sm.jpg",
        wiki: "A star like our sun gives off light and heat.",
        chinese: "恒星"
    }
}

</script>




<script>
    var bgwidth = 124;
    var bgheight = 182;

    var treeLayer;
    var leftLayer;
    var bglayer; //背景层；
    var usertipslayer;
    var loadingLayer ;//图片加载层

    //提示层
    var bubblelayer;
    var bubbleText = null;

    //存放的是tree drawable
    var larray= new Array();
    //left的LDrawable
    var lmap = {};
    // tree的Drawable
    var dmap = {};
    var bubbleHalfWidth= 103;
    var bubbleHeight = 98;
    var treeRoot = "Bigbang";

    var larraytmp = new Array();

    //当前是哪一个了
    window.index = 0;
    window.right = 0;
    window.lastDrawable = null;
    var interuptLimit = 2;

    function showInterupt(key)
    {
        //larraytmp = new Array();

        var count = 0;

        var addArray = new Array();

        for(var i = 0; i < larray.length;i++)
        {
            var ld = larray[i];
            if (ld.key == key) {
                continue;
            }
            else
            {
                ld.clear();
            }
        }


        for(var i = 0; i < larray.length;i++)
        {
            var ld = larray[i];
            if(ld.key == key)
            {
                continue;
            }

            if(Math.random() > 0.6)
            {
                ld.draw();
                count += 1;
                addArray.push(i);
            }

            if(count > interuptLimit)
                return;
        }


            while(addArray.length < 3)
            {
                var random = Math.floor(Math.random()*100) % (larray.length);
                var ld = larray[random];
                if(addArray.indexOf(random) < 0 && ld.key != key)
                {
                    addArray.push(random);
                    ld.draw();
                }
            }

    }

    function initTree(root)
    {
        treeLayer = new LSprite();

        treeLayer.x = 256;
        treeLayer.y = 20;

        addChild(treeLayer);

        var nodes = getNodes(pairs);
        var hs = getHierarchy(pairs,root);
       // alert(hs);
        dmap = renderTree(pairs,hs,treeLayer);
        linkTree(treeLayer,dmap,nodes,pairs);
        treeLayer.addEventListener(LMouseEvent.MOUSE_UP,onclick);
    }

//
//    function onclick(event)
//    {
//        //alert(event.offsetX);
//        var img = new Image();
//        img.src = "picture/nemo1/bg.png";
//        var bitmapdaga = new LBitmapData(img);
//        dmap["A"].bg.bitmapData = bitmapdaga;
//    }


    function initLeft()
    {
        leftLayer = new LSprite();
        leftLayer.x = 10;
        addChild(leftLayer);

        var height = 50;
        var y = 50;
        for(var key in map)
        {
            var ld = new LDrawable(leftLayer, 10,y,190,height,key);
            //ld.draw();
            lmap[key] = ld;
            larray.push(ld);
            y+=height*1.5;
        }

        prepare();

        leftLayer.addEventListener(LMouseEvent.MOUSE_UP,onclickl);
        leftLayer.addEventListener(LMouseEvent.MOUSE_MOVE,hover);

    }

    function prepare()
    {

        //----------------
        hideBubble();
        if(window.index >= pairs.length)
        {
            leftLayer.removeAllChild();
            $("body").scrollLeft(250);
            showmodalPanel(step2ok);
            return;
        }

        var keys = pairs[window.index];

        //起始的图片的key
        var key = keys[0];
        //显示
        dmap[key].draw();

        //当前要显示为 十字架的 左边的图片
        var currentKey = keys[1];
        window.right = currentKey;
        var currentLd = lmap[currentKey];
        currentLd.draw();//显示为待选
        showInterupt(currentLd.key);

        var lastTreeD = dmap[key];
        var currentTreeD = dmap[currentKey];
        window.lastDrawable = lastTreeD;
        //显示为十字架
        currentTreeD.drawbg1();

        //用线连接起来
        var position = link2drawable1(treeLayer,lastTreeD,currentTreeD);

        //取得bubble的提示xinx
        var relationkey = lastTreeD.key+currentTreeD.key;
        var bubbletext = relationship[relationkey];

        //显示提示信息
        showBubble(position[0]-bubbleHalfWidth,position[1]-bubbleHeight,bubbletext)

        window.index+=1;
    }


    //隐藏当前的，显示下一个个要选择的
    function hideshow()
    {

        // 上一个的keys
        var lastkeys = pairs[window.index-1];

        var lkey = lastkeys[1];

        var toshow = dmap[lkey];
        toshow.clear();
        toshow.draw();

        prepare();
    }

    /**
     * leftlayer function
     * @param event
     */
    function onclickl(event)
    {

        var x = event.offsetX;
        var y = event.offsetY;
        for(var i = 0; i < larray.length; i++)
        {

            var ld =  larray[i];
            if(ld.within(x,y) && ld.key == window.right)
            {
                  hideshow();
               // hideBubble();
            }
        }
        //setTimeout(function(){lds[0].drawbg();},1000);
    }


    function hover()
    {
        var x = event.offsetX;
        var y = event.offsetY;
        for(var i = 0; i < larray.length; i++)
        {

            var ld =  larray[i];
            if(ld.within(x,y))
            {
                ld.changebghover();
            }
            else
            {
                ld.changebgnormal();
            }
        }
    }

    function initBubbleLayer()
    {
        bubblelayer = new LSprite();
        addChild(bubblelayer);

        var img = new Image();
        img.src = "picture/nemo1/bubble.png";
        var bg = new LBitmap(new LBitmapData(img));
        bg.alpha = 1;
        bubblelayer.addChild(bg);

        bubbleText = new LTextField();
        bubbleText.color="#ffffff";
        bubbleText.size = 14;
        bubbleText.width = bg.getWidth()-20;
        bubbleText.setWordWrap(true);
        bubbleText.x = 5;
        bubbleText.y = 10;
        bubbleText.text = "bubble bubble";
        bubblelayer.addChild(bubbleText);
    }

    function hideBubble()
    {
        removeChild(bubblelayer);
    }

    function showBubble(x,y,text)
    {
        addChild(bubblelayer);
        bubblelayer.x = x+treeLayer.x;
        bubblelayer.y = y+treeLayer.y;
        bubbleText.text = text;
    }

    function initbglayer()
    {
        bglayer = new LSprite();
        addChild(bglayer);

        var img = new Image();
        img.src = backgroundpic;
        var bg = new LBitmap(new LBitmapData(img));
//        bg.scaleX=2;
//        bg.scaleY=2;
///        bg.alpha = 1;
        bglayer.addChild(bg);

    }

    function initusertipsLayer()
    {
        usertipslayer = new LSprite();
        addChild(usertipslayer);
    }


    var backgroundpic = "picture/nemo1/background.png";
    function collectImageData()
    {
        var imgData = new Array();
        imgData.push({name:"background",path:backgroundpic});
        imgData.push({name:"bg",path:"picture/nemo1/bg.png"});
        imgData.push({name:"bubble",path:"picture/nemo1/bubble.png"});
        imgData.push({name:"hover",path:"picture/nemo1/hover.png"});
        imgData.push({name:"selected",path:"picture/nemo1/selected.png"});
        imgData.push({name:"selected2",path:"picture/nemo1/selected2.png"});

        for(var i = 1;i <=9; i++)
            for(var j = 1; j <=4; j++)
            {
                imgData.push({name:"U"+i+""+j+".jpg",path:"picture/universe/"+"U"+i+""+j+".jpg"});
            }
        var count = 1;
        for(var key in map)
        {
           var item = map[key];
           imgData.push({name:item.word+"picmd",path:"picture/"+item.picmd});
           imgData.push({name:item.word+"picsm",path:"picture/"+item.picsm});
//
//           for(var j = 1; j <= 4; j++)
//           {
//               imgData.push({name:item.word+"U"+count+""+1,path:"picture/universe/U"+count+""+j+".jpg"});
//           }
//            count += 1;
        }

        return imgData;
    }
    LInit(100, "legend", 1800, 900, main);
    function main()
    {
        loadingLayer = new LoadingSample3();
        addChild(loadingLayer);
        var imgData = collectImageData();
        /**
         * LLoadManage.load($list,$onupdate,$oncomplete)
         * $list表示尧都区的图片数组
         * $onupdate表示读完一张图片后调用的函数，可以为空
         * $oncomplete表示读完所有数组中图片后调用的函数
         */
        LLoadManage.load(
                imgData,
                function (progress) //每读取一张图片
                {
                    loadingLayer.setProgress(progress);
                },
                function(result)//所有图片加载完了
                {
                    //所有图片的Image对象
                    removeChild(loadingLayer);
                    loadingLayer = null;
                    initall();
                    $("#left").show(200);
                    setTimeout(function() {
                        playaudio("/audio/bigbang.mp3");
                    }, 100);
                }
        );

    }

    function breakSendence(sendence,limit)
    {
            var splits = sendence.split(/\s+/);
            var index = 0;
            var currentwords = "";
            var words = "";
            for(var i = 0; i < splits.length; i++)
            {
                var word = splits[i];
                if((currentwords.length + word.length+1) > limit)
                {
                    words += currentwords + "\n ";
                    currentwords = word;
                }
                else
                {
                    currentwords += " "+word;
                }
            }

        words += currentwords;
        return words;
    }
    function initall()
    {
        initbglayer();
        //initBubbleLayer();
        initTree(treeRoot);
        //initLeft();
        //initusertipsLayer();
    }

    //window.location.href = "http://www.baicizhan.com";
</script>
