<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <title>demo for nemo</title>
  <style type="text/css">
    body { background-color: #fff; color: #666; text-align: center; font-family: arial, sans-serif; }
    div.dialog {
      width: 25em;
      padding: 0 4em;
      margin: 4em auto 0 auto;
      border: 1px solid #ccc;
      border-right-color: #999;
      border-bottom-color: #999;
    }
    h1 { font-size: 100%; color: #f00; line-height: 1.5em; }
  </style>


    <script src="js/lufylegend-1.9.0.min.js"></script>
</head>


<body>
  <div id="legend">
  </div>
</body>
</html>
<script>
    /**
     * layer is the layer of
     */
    function Drawable(layer,x,y,width,height,key)
    {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.layer = layer;
        this.key = key;
        this.pic = null;
        this.bg = null;
        this.word = null;
        this.wiki = null;
        this.chinese = null;
        this.voice = null;
    }

    Drawable.prototype = {
        drawbg1:function()
        {
            if(this.bg == null)
            {
                var img = new Image();
                img.src = "picture/nemo1/selected2.png";
                var bg = new LBitmap(new LBitmapData(img));
                bg.x = this.x;
                bg.y = this.y;
                this.bg = bg;
                this.layer.addChild(this.bg);
            }
        }
        ,
        drawbg:function()
        {
            if(this.bg == null)
            {
                var img = new Image();
                img.src = "picture/nemo1/bg.png";
                var bg = new LBitmap(new LBitmapData(img));
                bg.x = this.x;
                bg.y = this.y;
                this.bg = bg;
                this.layer.addChild(this.bg);
            }
        }
        ,
        drawdata:function()
        {
            var span = 30;
            var q = map[this.key];
            if (this.pic == null)
            {
                // picture
                var img = new Image();
                img.src = "picture/"+ q.picmd;
                var pic = new LBitmap(new LBitmapData(img));
                span = (this.width - pic.getWidth()) / 2;
                pic.x = this.x + span;
                pic.y = this.y + span;
                this.pic = pic;
                this.layer.addChild(this.pic);
            }

            // word
            //var q = map[this.key];
            if(this.word == null) {
                var textfield = new LTextField();
                this.word = textfield;
                this.word.width = this.bg.getWidth()*5/6;
                this.word.setWordWrap(true);
                this.word.size = 12;
                this.word.color="#3c3c3c";
                this.word.text = breakSendence(q.word,14);
                this.word.x = this.x + span;
                this.word.y = this.y + span + this.pic.getHeight()+5;
                this.layer.addChild(textfield);
            }

            // chinese
            //var q = map[this.key];
            if(this.chinese == null) {
                var textfield = new LTextField();
                this.chinese = textfield;
                this.chinese.size = 10;
                this.chinese.color="#3c3c3c";
                this.chinese.text = q.chinese;
                this.chinese.x = this.x + span+2 ;
                this.chinese.y = this.y + span + this.pic.getHeight()+this.word.getHeight()+10;
                this.layer.addChild(textfield);
            }
        }
        ,
        draw:function() {
            // this.layer.graphics.drawRect(1,"#000000",[this.x,this.y,this.width,this.height]);
            // background picture
            this.drawbg();
            this.drawdata();

        },

        heart:function()
        {
            var hx = this.x + this.width/2;
            var hy = this.y + this.height/2;

            return [hx,hy];
        },

        within:function(px,py)
        {
            if(px <= this.x+this.width && px >= this.x && py <= this.y+this.height && py >= this.y)
            {
                return true;
            }
            return false;
        }
        ,clear:function()
        {
            if(this.pic != null)
                this.layer.removeChild(this.pic);
            if(this.bg != null)
                this.layer.removeChild(this.bg);
            if(this.word != null)
                this.layer.removeChild(this.word);
            this.pic = null;
            this.bg = null;
            this.word = null;
        }
    }
</script>

<script>
    /**
     * layer is the layer of
     */
    function LDrawable(layer,x,y,width,height,key)
    {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.layer = layer;
        this.key = key;
        this.pic = null;
        this.bg = null;
        this.word = null;
        this.word1 = null;
        this.wiki = null;
        this.chinese = null;
        this.voice = null;
    }

    LDrawable.prototype = {
        drawbg:function()
        {
            if(this.bg == null)
            {
                var img = new Image();
                img.src = "picture/nemo1/selected.png";
                var bg = new LBitmap(new LBitmapData(img));
                bg.x = this.x;
                bg.y = this.y;
                this.bg = bg;
                this.layer.addChild(this.bg);
            }
        }
        ,
       changebghover:function()
       {
           if(this.bg != null)
           {
               var img = new Image();
               img.src = "picture/nemo1/hover.png";
               var hover = new LBitmapData(img);
               this.bg.bitmapData = hover;

           }
       }
        ,
        changebgnormal:function()
        {
            if(this.bg != null)
            {
                var img = new Image();
                img.src = "picture/nemo1/selected.png";
                var normal = new LBitmapData(img);
                this.bg.bitmapData = normal;

            }
        }

        ,
        drawdata:function()
        {
            var span = 4;
            var q = map[this.key];
            if (this.pic == null)
            {
                // picture
                var img = new Image();
                img.src = "picture/"+ q.picsm;
                var pic = new LBitmap(new LBitmapData(img));
                span = (this.height-pic.getHeight()) / 2;
                pic.x = this.x + span;
                pic.y = this.y + span;
                this.pic = pic;
                this.layer.addChild(this.pic);
            }

            // word
            //var q = map[this.key];
            if(this.word == null) {
                var textfield = new LTextField();
                this.word = textfield;
                this.word.text = q.chinese;
                this.word.x = this.x + span+this.pic.getWidth()+10;
                this.word.y = this.y + span/2;
                this.layer.addChild(this.word);
            }

            // word
            //var q = map[this.key];
            if(this.word1 == null) {
                var textfield = new LTextField();

                this.word1 = textfield;
                this.word1.size =12;
                this.word1.color = "#3c3c3c";
                this.word1.text = q.word;
                this.word1.x = this.x + span+this.pic.getWidth()+10;
                this.word1.y = this.y + span/2+20;
                this.layer.addChild(this.word1);
            }
        }
        ,
        draw:function() {
            // this.layer.graphics.drawRect(1,"#000000",[this.x,this.y,this.width,this.height]);
            // background picture
            this.drawbg();
            this.drawdata();

        },

        heart:function()
        {
            var hx = this.x + this.width/2;
            var hy = this.y + this.height/2;

            return [hx,hy];
        },

        within:function(px,py)
        {
            if(px <= this.x+this.width && px >= this.x && py <= this.y+this.height && py >= this.y)
            {
                return true;
            }
            return false;
        },

        clear:function()
        {
            if(this.pic != null)
                this.layer.removeChild(this.pic);
            if(this.bg != null)
                this.layer.removeChild(this.bg);
            if(this.word != null)
                this.layer.removeChild(this.word);
            if(this.word1 != null)
                this.layer.removeChild(this.word1);


            this.pic = null;
            this.bg = null;
            this.word = null;
            this.word1 = null;
        }
    }
</script>

<script>

    function getNodes(pairs)
    {
        var nodes = [];

        for(var i = 0; i < pairs.length; i++)
        {
            var r = pairs[i];
            if(nodes.indexOf(r[0]) < 0)
                nodes.push(r[0]);
            if(nodes.indexOf(r[1]) < 0)
                nodes.push(r[1]);
        }

        return nodes;
    }
    function getHierarchy(pairs,root)
    {
        var nodes = getNodes(pairs);
        var layers = [];
        layers.push([root]);
        var nodecount = 1;
        var layercount = 0;
        while(nodecount <= nodes.length)
        {
            var prelayer = layers[layercount];

            var currentlayer = [];
            for(var i = 0; i < prelayer.length; i++)
            {
                var tmp = prelayer[i];
                var children = findChildren(pairs,tmp);
                addArray2Array(children, currentlayer);
                nodecount+=children.length;

            }

            layers.push(currentlayer);

            if(layercount>10)
                break;
            layercount+=1;
        }
        return layers;

    }


    function renderTree(pairs,hs,layer)
    {
        drawableMap = {};
        var count = 1;
        for(var i = 0; i < hs.length; i++)
        {
            var h = hs[i];
            for(var j = 0; j < h.length; j++)
            {
                var d = new Drawable(layer, i*(bgwidth+bgwidth)+10,j*(bgheight+bgheight/4)+10,bgwidth,bgheight,h[j]);
                drawableMap[h[j]] = d;

                count++;
            }
        }

        return drawableMap;
    }

    /**
     * find children of elem
     * @param pair
     * @param elem
     */
    function findChildren(pairs,elem)
    {
        var children = [];
        for(var i = 0; i < pairs.length; i++)
        {
            var pair = pairs[i];
            if(pair[0] == elem)
                children.push(pair[1])
        }

        return children;
    }

    function addArray2Array(array1,array2)
    {
        if (array1 == null || array1.length == 0)
            return ;

        for(var i = 0; i < array1.length; i++)
        {
            if(array2.indexOf(array1[i]) < 0)
            {
                array2.push(array1[i]);
            }
        }
    }

    /**
     * 用线将将两个drawable连起来。
     * @param d1
     * @param d2
     */
    function link2drawable(layer,d1,d2)
    {
        if(d1 == null || d2 == null)
            return ;
        var p1heart = d1.heart();
        var p2heart = d2.heart();

        p1x = p1heart[0]+d1.width/2;
        p1y = p1heart[1];

        p2x = p2heart[0]-d2.width/2;
        p2y = p2heart[1];

        p3x = p1x+(p2x - p1x)/2;

        layer.graphics.drawLine(0.5,"#fcfcfc",[p1x,p1y,p3x,p1y]);
        layer.graphics.drawLine(0.5,"#fcfcfc",[p3x,p1y,p3x,p2y]);
        layer.graphics.drawLine(0.5,"#fcfcfc",[p3x,p2y,p2x,p2y]);
        return [p3x,(p1y+p2y)/2]
    }

    /**
     * 用线将将两个drawable连起来。
     * @param d1
     * @param d2
     */
    function link2drawable1(layer,d1,d2)
    {
        if(d1 == null || d2 == null)
            return ;
        var p1heart = d1.heart();
        var p2heart = d2.heart();

        p1x = p1heart[0]+d1.width/2;
        p1y = p1heart[1];

        p2x = p2heart[0]-d2.width/2;
        p2y = p2heart[1];

        p3x = p1x+(p2x - p1x)/2;

        layer.graphics.drawLine(0.5,"#7ecefd",[p1x,p1y,p3x,p1y]);
        layer.graphics.drawLine(0.5,"#7ecefd",[p3x,p1y,p3x,p2y]);
        layer.graphics.drawLine(0.5,"#7ecefd",[p3x,p2y,p2x,p2y]);

        return [p3x,(p1y+p2y)/2]
    }

    function linkTree(layer,drawablemap,nodes,pairs)
    {
        for(var i = 0; i < nodes.length; i++)
        {
            var node = nodes[i];
            var drawable1 = drawablemap[node];
            var children = findChildren(pairs,node);
            for(var j = 0; j < children.length; j++)
            {
                var cnode = children[j];
                var drawable2 = drawablemap[cnode];
                link2drawable(layer,drawable1,drawable2);
            }
        }
    }

</script>

<script>
    var pairs =[
        ["Bigbang","Universe","What does big bang create?"],
        ["Universe","Galaxy","What is made of millions of stars,gas and dust?"],
        ["Galaxy","Elliptical galaxy","What galaxy is oval in shape?"],
        ["Galaxy","Spiral galaxy","What galaxy is shaped like a giant whirlpool?"],
        ["Spiral galaxy","Andromeda galaxy","Which galaxy is indicated to collide with Milky Way galaxy?"],
        ["Spiral galaxy","Milky Way galaxy","Which galaxy looks like a band of light observed from earth?"],
        ["Milky Way galaxy","Solar system","What is made up of the sun surrounded by planets and other objects?"],
        ["Milky Way galaxy","Star","What can give off heat and light in the galaxy?"]
    ];

    //节点之间的线 关系
    var relationship = {};
    for(var i = 0; i < pairs.length; i++)
    {
        var pair = pairs[i];
        relationship[pair[0]+pair[1]] = pair[2];
    }

</script>




<script>

var map = {
    "Bigbang": {
        word: "Bigbang",
        pic: "U11.png",
        picmd: "U11md.jpg",
        picsm: "U11sm.jpg",
        wiki: "The universe began with an explosion, the explosion is called the big bang",
        chinese: "宇宙大爆炸"
    },
    "Universe": {
        word: "Universe",
        pic: "U21.png",
        picmd: "U21md.jpg",
        picsm: "U21sm.jpg",
        wiki: "The Universe contains earth, planets, stars and everything else in outer space. ",
        chinese: "宇宙"
    },
    "Galaxy": {
        word: "Galaxy",
        pic: "U31.png",
        picmd: "U31md.jpg",
        picsm: "U31sm.jpg",
        wiki: "A galaxy is made up of millions and billions of stars, gas and dust",
        chinese: "星系"
    },
    "Elliptical galaxy": {
        word: "Elliptical galaxy",
        pic: "U41.png",
        picmd: "U41md.jpg",
        picsm: "U41sm.jpg",
        wiki: "An elliptical galaxy is oval or round in shape.",
        chinese: "椭圆星系"
    },
    "Spiral galaxy": {
        word: "Spiral galaxy",
        pic: "U51.png",
        picmd: "U51md.jpg",
        picsm: "U51sm.jpg",
        wiki: "A spiral galaxy is shaped like a giant whirlpool or pinwheel.",
        chinese: "螺旋星系"
    },
    "Andromeda galaxy": {
        word: "Andromeda galaxy",
        pic: "U61.png",
        picmd: "U61md.jpg",
        picsm: "U61sm.jpg",
        wiki: "Andromeda galaxy is a large spiral galaxy，it is indicated to collide with Milky Way galaxy to form an elliptical galaxy",
        chinese: "仙女座星系"
    },
    "Milky Way galaxy": {
        word: "Milky Way galaxy",
        pic: "U71.png",
        picmd: "U71md.jpg",
        picsm: "U71sm.jpg",
        wiki: "Milky Way galaxy is a spiral galaxy and it looks like a band of light observed from earth",
        chinese: "银河系"
    },
    "Solar system": {
        word: "Solar system",
        pic: "U81.png",
        picmd: "U81md.jpg",
        picsm: "U81sm.jpg",
        wiki: "Solar system is made up of the sun surrounded by planets and other objects in Milky Way galaxy.",
        chinese: "太阳系"
    },
    "Star": {
        word: "Star",
        pic: "U91.png",
        picmd: "U91md.jpg",
        picsm: "U91sm.jpg",
        wiki: "A star gives off heat and light, like the sun.",
        chinese: "恒星"
    }
}

</script>




<script>
    var bgwidth = 124;
    var bgheight = 182;

    var treeLayer;
    var leftLayer;
    var bglayer; //背景层；
    var usertipslayer;
    var loadingLayer ;//图片加载层

    //提示层
    var bubblelayer;
    var bubbleText = null;

    //存放的是tree drawable
    var larray= new Array();
    //left的LDrawable
    var lmap = {};
    // tree的Drawable
    var dmap = {};
    var bubbleHalfWidth= 103;
    var bubbleHeight = 98;
    var treeRoot = "Bigbang";

    var larraytmp = new Array();

    //当前是哪一个了
    window.index = 0;
    window.right = 0;
    window.lastDrawable = null;
    var interuptLimit = 2;

    function showInterupt(key)
    {
        //larraytmp = new Array();

        var count = 0;

        var addArray = new Array();

        for(var i = 0; i < larray.length;i++)
        {
            var ld = larray[i];
            if (ld.key == key) {
                continue;
            }
            else
            {
                ld.clear();
            }
        }


        for(var i = 0; i < larray.length;i++)
        {
            var ld = larray[i];
            if(ld.key == key)
            {
                continue;
            }

            if(Math.random() > 0.6)
            {
                ld.draw();
                count += 1;
                addArray.push(i);
            }

            if(count > interuptLimit)
                return;
        }


            while(addArray.length < 3)
            {
                var random = Math.floor(Math.random()*100) % (larray.length);
                var ld = larray[random];
                if(addArray.indexOf(random) < 0 && ld.key != key)
                {
                    addArray.push(random);
                    ld.draw();
                }
            }

    }

    function initTree(root)
    {
        treeLayer = new LSprite();

        treeLayer.x = 256;
        treeLayer.y = 20;

        addChild(treeLayer);

        var nodes = getNodes(pairs);
        var hs = getHierarchy(pairs,root);
       // alert(hs);
        dmap = renderTree(pairs,hs,treeLayer);
        //linkTree(treeLayer,dmap,nodes,pairs);
        treeLayer.addEventListener(LMouseEvent.MOUSE_UP,onclick);
    }


    function onclick(event)
    {
        //alert(event.offsetX);
        var img = new Image();
        img.src = "picture/nemo1/bg.png";
        var bitmapdaga = new LBitmapData(img);
        dmap["A"].bg.bitmapData = bitmapdaga;
    }


    function initLeft()
    {
        leftLayer = new LSprite();
        leftLayer.x = 10;
        addChild(leftLayer);

        var height = 50;
        var y = 50;
        for(var key in map)
        {
            var ld = new LDrawable(leftLayer, 10,y,190,height,key);
            //ld.draw();
            lmap[key] = ld;
            larray.push(ld);
            y+=height*1.5;
        }

        prepare();

        leftLayer.addEventListener(LMouseEvent.MOUSE_UP,onclickl);
        leftLayer.addEventListener(LMouseEvent.MOUSE_MOVE,hover);

    }

    function prepare()
    {

        //----------------
        hideBubble();
        if(window.index >= pairs.length)
        {
            leftLayer.removeAllChild();
            return;
        }

        var keys = pairs[window.index];

        //起始的图片的key
        var key = keys[0];
        //显示
        dmap[key].draw();

        //当前要显示为 十字架的 左边的图片
        var currentKey = keys[1];
        window.right = currentKey;
        var currentLd = lmap[currentKey];
        currentLd.draw();//显示为待选
        showInterupt(currentLd.key);

        var lastTreeD = dmap[key];
        var currentTreeD = dmap[currentKey];
        window.lastDrawable = lastTreeD;
        //显示为十字架
        currentTreeD.drawbg1();

        //用线连接起来
        var position = link2drawable1(treeLayer,lastTreeD,currentTreeD);

        //取得bubble的提示xinx
        var relationkey = lastTreeD.key+currentTreeD.key;
        var bubbletext = relationship[relationkey];

        //显示提示信息
        showBubble(position[0]-bubbleHalfWidth,position[1]-bubbleHeight,bubbletext)

        window.index+=1;
    }


    //隐藏当前的，显示下一个个要选择的
    function hideshow()
    {

        // 上一个的keys
        var lastkeys = pairs[window.index-1];

        var lkey = lastkeys[1];

        var toshow = dmap[lkey];
        toshow.clear();
        toshow.draw();

        prepare();
    }

    /**
     * leftlayer function
     * @param event
     */
    function onclickl(event)
    {

        var x = event.offsetX;
        var y = event.offsetY;
        for(var i = 0; i < larray.length; i++)
        {

            var ld =  larray[i];
            if(ld.within(x,y) && ld.key == window.right)
            {
                  hideshow();
               // hideBubble();
            }
        }
        //setTimeout(function(){lds[0].drawbg();},1000);
    }


    function hover()
    {
        var x = event.offsetX;
        var y = event.offsetY;
        for(var i = 0; i < larray.length; i++)
        {

            var ld =  larray[i];
            if(ld.within(x,y))
            {
                ld.changebghover();
            }
            else
            {
                ld.changebgnormal();
            }
        }
    }

    function initBubbleLayer()
    {
        bubblelayer = new LSprite();
        addChild(bubblelayer);

        var img = new Image();
        img.src = "picture/nemo1/bubble.png";
        var bg = new LBitmap(new LBitmapData(img));
        bg.alpha = 1;
        bubblelayer.addChild(bg);

        bubbleText = new LTextField();
        bubbleText.color="#ffffff";
        bubbleText.size = 14;
        bubbleText.width = bg.getWidth()-20;
        bubbleText.setWordWrap(true);
        bubbleText.x = 5;
        bubbleText.y = 10;
        bubbleText.text = "bubble bubble";
        bubblelayer.addChild(bubbleText);
    }

    function hideBubble()
    {
        removeChild(bubblelayer);
    }

    function showBubble(x,y,text)
    {
        addChild(bubblelayer);
        bubblelayer.x = x+treeLayer.x;
        bubblelayer.y = y+treeLayer.y;
        bubbleText.text = text;
    }

    function initbglayer()
    {
        bglayer = new LSprite();
        addChild(bglayer);

        var img = new Image();
        img.src = "picture/nemo1/background.jpg";
        var bg = new LBitmap(new LBitmapData(img));
        bg.scaleX=2;
        bg.scaleY=2;
        bg.alpha = 1;
        bglayer.addChild(bg);

    }

    function initusertipsLayer()
    {
        usertipslayer = new LSprite();
        addChild(usertipslayer);
    }


    function collectImageData()
    {
        var imgData = new Array();
        imgData.push({name:"background",path:"picture/nemo1/background.jpg"});
        imgData.push({name:"bg",path:"picture/nemo1/bg.png"});
        imgData.push({name:"bubble",path:"picture/nemo1/bubble.png"});
        imgData.push({name:"hover",path:"picture/nemo1/hover.png"});
        imgData.push({name:"selected",path:"picture/nemo1/selected.png"});
        imgData.push({name:"selected2",path:"picture/nemo1/selected2.png"});

        for(var key in map)
        {
           var item = map[key];
           imgData.push({name:item.word+"picmd",path:"picture/"+item.picmd});
           imgData.push({name:item.word+"picsm",path:"picture/"+item.picsm});
        }

        return imgData;
    }
    LInit(100, "legend", 1800, 900, main);
    function main()
    {
        loadingLayer = new LoadingSample3();
        addChild(loadingLayer);
        var imgData = collectImageData();
        /**
         * LLoadManage.load($list,$onupdate,$oncomplete)
         * $list表示尧都区的图片数组
         * $onupdate表示读完一张图片后调用的函数，可以为空
         * $oncomplete表示读完所有数组中图片后调用的函数
         */
        LLoadManage.load(
                imgData,
                function (progress) //每读取一张图片
                {
                    loadingLayer.setProgress(progress);
                },
                function(result)//所有图片加载完了
                {
                    //所有图片的Image对象
                    removeChild(loadingLayer);
                    loadingLayer = null;
                    initall();
                }
        );

    }

    function breakSendence(sendence,limit)
    {
            var splits = sendence.split(/\s+/);
            var index = 0;
            var currentwords = "";
            var words = "";
            for(var i = 0; i < splits.length; i++)
            {
                var word = splits[i];
                if((currentwords.length + word.length+1) > limit)
                {
                    words += currentwords + "\n ";
                    currentwords = word;
                }
                else
                {
                    currentwords += " "+word;
                }
            }

        words += currentwords;
        return words;
    }
    function initall()
    {
        initbglayer();
        initBubbleLayer();
        initTree(treeRoot);
        initLeft();
        initusertipsLayer();
    }


</script>
