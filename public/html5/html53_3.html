<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <title>demo for nemo</title>
  <style type="text/css">
    body { background-color: #fff; color: #666; text-align: center; font-family: arial, sans-serif; }
    div.dialog {
      width: 25em;
      padding: 0 4em;
      margin: 4em auto 0 auto;
      border: 1px solid #ccc;
      border-right-color: #999;
      border-bottom-color: #999;
    }
    h1 { font-size: 100%; color: #f00; line-height: 1.5em; }
  </style>
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/js/jquery-1.10.2.js"></script>


    <!-- 最新 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="/js/bootstrap.min.js"></script>
    <!--<script src="/js/jquery.timer.js"></script>-->

    <script type="text/javascript" src="/js/jplayer/jquery.jplayer.min.js"></script>
    <script type="text/javascript" src="/js/jquery.pin.js"></script>
    <script src="js/lufylegend-1.9.0.min.js"></script>
    <style>

        #loading{position:fixed;_position:absolute;top:50%;left:50%;width:124px;height:124px;overflow:hidden;background:url(http://www.mb-wx.com/skins/Nuvola/loaderc.gif) no-repeat;z-index:7; margin:-62px 0 0 -62px;}
        .answersection
        {
            padding:5px;
            font-size: 18px;
        }
        .picsection
        {
             padding:5px;

        }

        .picsection img
        {
            width:180px;
            height:180px;
            padding:10px;
        }

        #chinese
        {

            font-size: 18px;
            color:#000000;
        }

        #english{
            font-size: 20px;
            color:#000000;
        }
        .shouldhide
        {
            font-size: 18;
            color:#000000;

        }
        #infodiv
        {
            text-align: left;
        }

        .lilabel
        {
            color:#7dcefd;
            font-size: 22px;
            margin-right: 5px;
        }

        #play
        {
            font-size: 26px;
            padding-left: 8px;
        }
        .preclass
        {
            font-size: 14px;
        }
    </style>
</head>

<script>

    Array.prototype.contains = function(obj) {
        var i = this.length;
        while (i--) {
            if (this[i] === obj) {
                return true;
            }
        }
        return false;
    }

    function trim (value) {
        if(value == null || value == undefined)
            return null;

        return   value.replace(/^\s+|\s+$/g, '');
    }

    function preloadimages(arr){
        var newimages=[]
        var arr=(typeof arr!="object")? [arr] : arr  //确保参数总是数组
        for (var i=0; i<arr.length; i++){
            newimages[i]=new Image()
            newimages[i].src=arr[i]
        }
    }

</script>

<script>

    var ajaxurl = "ONE_solar_system.txt";
    var ajaxurls = ["ONE_solar_system.txt", "ONE_Mercury.txt", "ONE_Venus.txt", "ONE_Earth.txt","ONE_Mars.txt", "ONE_Jupiter.txt", "ONE_Saturn.txt", "ONE_Uranus.txt", "ONE_Neptune.txt"];
</script>
<script>

    function GetUrlParms() {
        var args = new Object();
        var query = location.search.substring(1); //获取查询串
        var pairs = query.split("&"); //在逗号处断开
        for (var i = 0; i < pairs.length; i++) {
            var pos = pairs[i].indexOf('='); //查找name=value
            if (pos == -1) continue; //如果没有找到就跳过
            var argname = pairs[i].substring(0, pos); //提取name
            var value = pairs[i].substring(pos + 1); //提取value
            args[argname] = unescape(value); //存为属性
        }
        return args;
    }
    //调用方法
    var args = new Object();
    args = GetUrlParms();
    var argsValue = args["taskIndex"];
    var taskIndex= 0;
    if(argsValue != null && argsValue != undefined)
         taskIndex=parseInt(argsValue);
    if(taskIndex >= ajaxurls.length)
    {
        alert("没有了喔！");
    }
   // alert(argsValue);

</script>
<script>
    var imagUrlPre = "http://demo.baicizhan.com:9008/talent/image/upload/";
    window.qindex = 0;
    var wrongpicsm = "http://baicizhan.qiniudn.com/pack/assets/done-wrong.png";
    var rightpicsm = "http://baicizhan.qiniudn.com/pack/assets/done-right.png";

    var wrongpic = "/html5/picture/nemo1/wrong.jpg";
    var rightpic = "/html5/picture/nemo1/right.jpg";

    /**
     * get quesion according to index
     * @param index
     * @returns {*}
     */
    function getQuesion(index)
    {
        if(index < 0)
            return null;
        var count = 0;
        for(var q in map)
        {
           if(count == index)
           {
               var question = map[q];
               return question;
           }
           count++;
        }

        return null;
    }



/**
 * get size of a map.
 */
function getMapSize(map)
{
    if(map == null || map == undefined)
        return 0;

    var count = 0;
    for(var q in map)
    {
        count++;
    }

    return count;
}

// 0表示单词选图 1表示选图
var CHOOSEPIC = 0;
var CHOOSEWORD = 1;
window.round = CHOOSEWORD;

 /**
  * 获取大于等于0小于等于max的n个数字,除了except
  */
function getRandom(n,except,max)
{
    var array = new Array();
    while(array.length <= n)
    {
        var random = Math.floor(Math.random()*max);
        //如果是except 或者array中已经有了random，那么继续选择
        if(random == except || array.contains(random) > 0)
            continue;

        array.push(random);
    }
    return array;
}

    /**
     * 显示提示框
     */
function showTipBox()
{
    $("#show_tip_div").show();
    var width = $(window).width;
    $("#show_tip_div").css("left",width/2-100);

}


function scroll2Top(margin)
{
    //alert("---");
    if( $("#sm-card-div") != null &&  $("#sm-card-div").length >0)
         $("#sm-card-div")[0].scrollTop = margin;
}

    /**
 * 单词选意思
 *
 */
function renderQuestion1(index)
{
    $(".picsection").hide();
    $("#questionDivs").show();
    $(".answersection").show();
    //scrollLeftTop();
    if(index > 8)
        scroll2Top(800);
    if(index > 16)
        scroll2Top(1400);

    //当前问题
    var q  = getQuesion(index);

    //如果是最后一个 就...
    if(q == null || q == undefined)
    {

        for(var key in dmap)
        {
            dmap[key].clear();
        }

        $("#left").hide();
        _renderAllSmallCard();
        showmodalPanel(step1ok);
        showTipBox();
        initbglayer();
        //initBubbleLayer();
        initTree(treeRoot);
        initLeft();
        initusertipsLayer();
        $("#legend").show();
        return;
    }

    //上一个问题
    var preq = getQuesion(index-1);

    $("#english").text(q.word);
    //播放声音
    playaudio(q.audio);

    if(preq == null )
    {
        $(".preclass").hide();
    }
    else
    {
        $(".preclass").show();
        $("#preword").text(preq.word);
        $("#prechinese").text(preq.chinese);
    }

    $("#chinese").text(q.chinese);
    $("#wiki").text(q.wiki);
    $("#next").hide();
    $(".shouldhide").hide();

    $("#qpic").find("img").attr("src",imagUrlPre+ q.pic);


    //填答案
    var mapsize = getMapSize(map);
    //随机生成干扰问题的下标数组
    var interuptArray = getRandom(2,index,mapsize);
    //随机生成正确答案的位置
    var insertPostion = (index+Math.floor(Math.random()*100))%3;
    interuptArray.splice(insertPostion,0,index);

    //开始填答案
    for(var i = 0 ; i < interuptArray.length; i++)
    {
        var qi  = interuptArray[i];
        var question = getQuesion(qi);
        var $word = $("#word"+i)
        $word.text(question.chinese);

        var cls = "wrong";
        var tippic = wrongpicsm;
        if(qi == index)
        {
            cls = " right";
            tippic = rightpicsm;
        }

        $word.attr("class",cls);

        var $img = $word.parent().find("img");
        $img.attr("src",tippic);
        $img.hide();
    }



    $(".right").unbind("click");
    $(".wrong").unbind("click");
    $("#next").unbind("click");
    $(".right").on("click",function(){
//        //alert($(this).attr("src"));
//        //钩钩图片效果
//        //$(".shouldhide").show();
//        //show next button
//        $("#next").show(500);
//        var $img = $(this).parent().find("img");
//        $img.show(200)
//        $img.hide(200);
        showSmallCardWords(index);
        $("#next").click();
    });

    //叉叉图片效果
    $(".wrong").on("click",function(){
        //$(".shouldhide").show();
        var $next
        var $img = $(this).parent().find("img");
        $img.show(200)
        $img.hide(200);
        $("#next").hide(500);
    });

    $("#next").on("click",function(){
        window.qindex+=1;
        //alert("wright");
        renderQuestion1(window.qindex);

    });

    var audio = imagUrlPre+q.audio;
    $("#play").on("mouseover",function(){
        $(this).attr("class","glyphicon glyphicon-volume-up");
        playaudio(audio);
    }).on("mouseout",function(){
        $(this).attr("class","glyphicon glyphicon-volume-down");

    });

}

/**
 * 单词炫图
 * @param index
 */
function renderQuestion(index)
{
    $(".picsection").show();
    $(".answersection").hide();
    scroll2Top(1000);

    //文件编号
    var array = [1,2];
    var q  = getQuesion(index);
    var preq = getQuesion(index-1);

    //如果是最后一个 就...
    if(q == null || q == undefined)
    {
        window.qindex = 0;
        hideSmallCardWords();
        hideBigCard();
        scroll2Top(1);
       // hideQuestionDiv();
        renderQuestion1(0);
        //$(".answersection").show();
        showmodalPanel(step2beginword);
       return;
    }

    showQuestionDiv();
    //大卡片,但是不显示
    renderBigCard(index);

    $("#english").text(q.word);
    //播放声音
    playaudio(imagUrlPre+q.audio);

    if(preq == null )
    {
        $(".preclass").hide();
    }
    else
    {
        $(".preclass").show();
        $("#preword").text(preq.word);
        $("#prechinese").text(preq.chinese);
    }

    $("#chinese").text(q.chinese);
    $("#wiki").text(q.wiki);
    $("#next").hide();
    $(".shouldhide").hide();

    //打文件 将第一个(正确答案)与random
    var random = Math.floor(Math.random()*10)%2;
    var tmp = array[random];
    array[random] = array[0];
    array[0] = tmp;

    var randomIndex = Math.floor(Math.random()*getMapSize(map));
    if(randomIndex == index)
    {
        if(randomIndex == 0)
            randomIndex += 1;
        else if(randomIndex == getMapSize(map)-1)
            randomIndex -= 1;
        else randomIndex += 1;

    }

    var interuptQuestion = getQuesion(randomIndex);

    var count = 1;
    for(var i = 0; i < array.length; i++)
    {
        var picnum = array[i];
        var picid = "pic" + count;
        $("#" + picid).attr("src", imagUrlPre+ q.pic);

        // 添加class给每一个图片 正确的class是right 错误的是wrong
        var cls = $("#" + picid).attr("class");
        if(cls == null || cls == "undefined")
            cls = "";
        if(picnum == 1)
            cls = " right";
        else
        {
            cls = " wrong";
            $("#" + picid).attr("src", imagUrlPre+ interuptQuestion.pic);
        }

        $("#" + picid).attr("class",cls);
        count++;
    }

    $(".right").unbind("click");
    $(".wrong").unbind("click");
    $("#next1").unbind("click");
    $(".right").on("click",function(event){
        //alert($(this).attr("src"));
        //钩钩图片效果
        $(".shouldhide").show();
        //show next button
//        $("#next").show(500);
//
//        var originpic = $(this).attr("src");
//        $(this).attr("picselected",originpic);
//        $(this).attr("jihao","jihao");
//        $(this).attr("src",rightpic);
//        var $bigpicdiv = $("#bigpicture");
//        var $bigpic = $bigpicdiv.find("img");
//        $bigpic.attr("src",originpic);

//        var $offset = $("#infodiv");
//        $bigpicdiv.css({"top":($offset.height()+90)+"px","left":50+"px"});
//        $bigpicdiv.show(300);
       // $bigpicdiv(200);

        renderSmallCard(index);
        showBigCard();
        hideQuestionDiv();
//        setTimeout(function(){
//            var $img = $("img[jihao='jihao']");
//            $img.attr("src",originpic);
//            $img.attr("jihao","");
//            $bigpicdiv.hide(300);
//        },1500);

    });

    //叉叉图片效果
    $(".wrong").on("click",function(){
        $(".shouldhide").show();
        var originpic = $(this).attr("src");
        $(this).attr("picselected",originpic);
        $(this).attr("jihao","jihao");
        $(this).attr("src",wrongpic);

        setTimeout(function(){
           var $img = $("img[jihao='jihao']");
           $img.attr("src",originpic);
            $img.attr("jihao","");

        },500);
    });

    $("#next1").on("click",function(){

        //点亮右边的东西;
        var q = getQuesion(window.qindex);
        var key = q.word;
       // var d = dmap[key];
       // d.draw();
       // $("#left").hide(100);
        //$("body").scrollLeft(250);
        window.qindex+=1;
       // alert(window.qindex);
        renderQuestion(window.qindex);
    });

    var audio = imagUrlPre+q.audio;
    $("#play").on("mouseover",function(){
        $(this).attr("class","glyphicon glyphicon-volume-up");
        playaudio(audio);
    }).on("mouseout",function(){
        $(this).attr("class","glyphicon glyphicon-volume-down");

    });
}

//显示左边的小卡片
function renderSmallCard(index)
{
      var question = getQuesion(index);
      //  alert(question.wiki);
        var $smcard_item = $("#sm-card-item").clone(true);
        $smcard_item.css("display","");

        var $smcard_pic =  $smcard_item.find(".sdcard-pic");
        $smcard_pic.attr("src",imagUrlPre+question.pic);
    
        var $smcard_chinese =  $smcard_item.find(".smcard-chinese");
        $smcard_chinese.text(question.chinese);

        var $smcard_english =  $smcard_item.find(".smcard-english");
        $smcard_english.text(question.word);

        $smcard_item.appendTo($("#sm-card"));
}

//显示大图片
function renderBigCard(index)
{
    var question = getQuesion(index);
    var $bigcard = $("#bigcard");
  //  alert($bigcard);
    var $bigcard_pic = $bigcard.find(".bigcard-pic");
    $bigcard_pic.attr("src",imagUrlPre+question.pic);

    var $bigcard_english =  $bigcard.find(".bigcard-english");
    $bigcard_english.text(question.word);
   // alert(question.word+$bigcard_english.text());

    var $bigcard_wiki =  $bigcard.find(".bigcard-wiki");
    $bigcard_wiki.text(question.wiki);
    $bigcard.hide();

}

function hideBigCard()
{
    var $bigcard = $("#bigcard");
    $bigcard.hide();
}

function showBigCard()
{
    var $bigcard = $("#bigcard");
    $bigcard.show(500);
}

function hideQuestionDiv()
{
    $("#questionDivs").hide();
}

function showQuestionDiv()
{
    $("#questionDivs").show();
}

function hideSmallCardWords()
{
    var $sm_cards_chinese = $(".smcard-chinese")
    for(var i = 0; i < $sm_cards_chinese.length; i++)
    {
      $($sm_cards_chinese[i]).hide();
    }

    var $sm_cards_english = $(".smcard-english")
    for(var i = 0; i < $sm_cards_english.length; i++)
    {
        $($sm_cards_english[i]).hide();
    }
}

function showSmallCardWords(index)
{
    var $sm_cards_chinese = $(".smcard-chinese")
    for(var i = 0; i < $sm_cards_chinese.length; i++)
    {
        if(index == i)
        {
            $($sm_cards_chinese[i+1]).show();
            break;
        }
    }

    var $sm_cards_english = $(".smcard-english")
    for(var i = 0; i < $sm_cards_english.length; i++)
    {
        if(index == i)
        {
            $($sm_cards_english[i+1]).show();
            break;
        }
    }
}

window.qindex = 0;

var step1ok = "恭喜您！通过了第一关的测试！下一关，我们要把学过知识拼成知识图谱，<br>请根据提示，从左边的卡片中选择一个，用鼠标点击，放到左边的十字架中。"
var step2beginword = "下面我们来复习一下学过的单词";
var step2ok = "恭喜您！将孤立的知识链接成了知识图谱！放个 ~人工烟花~~";
function showmodalPanel(text)
{
    $("#modaltext").html(text);
    $('#myModal').modal('show');
}

</script>

<body>
<div id="loading"></div>
<div id="jquery_jplayer_1"></div>
  <div id="bigpicture" style="position: absolute; z-index: 999;display: none">
      <a href="#" class="thumbnail">
          <img width="360"  height="720" src="">
      </a>
  </div>

  <div class="container-fluid" id="container">
      <div class="modal fade" id="myModal" tabindex="-1" role="dialog" style="display: none"
           aria-labelledby="myModalLabel" aria-hidden="true">
          <div class="modal-dialog">
              <div class="modal-content">
                  <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal"
                              aria-hidden="true">
                      </button>
                      <!--<h4 class="modal-title" id="myModalLabel">-->
                          <!--模态框（Modal）标题-->
                      <!--</h4>-->
                  </div>
                  <div class="modal-body" id="modaltext">
                     恭喜您！通过了第一关的测试！下一关，我们要把学过知识拼成知识图谱，<br>
                     请根据提示，从左边的卡片中选择一个，用鼠标点击，放到左边的十字架中。
                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn btn-default"
                              data-dismiss="modal">
                          关闭
                      </button>

                  </div>
              </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
      </div><!-- /.modal -->

      <li class="list-group-item sm-card-item" id="sm-card-item" style="display:none">
          <div class="row" >
              <div class="col-md-4">
                  <img class="sdcard-pic" width=50 src="picture/universe/U11.jpg" />
              </div>
              <div class="col-md-8">
                  <div class="row" style="text-align: left; font-size: 20px">
                      <span class="smcard-chinese">火星</span>
                  </div>
                  <div class="row" style="text-align: left">
                      <span class="smcard-english">Mars</span>
                  </div>
              </div>
          </div>
      </li>

      <div class="col-md-12" id="left" style="margin-top: 10px;display: none">
        <div class="col-md-3 col-md-offset-2" id="sm-card-div" style="height: 600px; overflow:scroll;border: 0px">
            <ul class="list-group-item" id="sm-card" style="border:0px;">
            </ul>
        </div>

        <!-- 显示大卡片 -->
        <div class="col-md-4"  id="bigcard" style="display: none">
            <div class="col-md-12 panel panel-default" style="padding-bottom: 10px;padding-top: 10px">
                <div class="row">
                    <div class="col-md-10 col-md-offset-1">
                         <a class="thumbnail" href="#"><img class="bigcard-pic" src="picture/universe/U11.jpg"/> </a>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-10 col-md-offset-1" style="text-align: left; font-size: 25px">
                        <span class="bigcard-english">螺旋星系</span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-10 col-md-offset-1" style="text-align: left">
                        <span class="bigcard-wiki">The universe began with an explosion, the explosion is called the big bang.</span>
                    </div>
                </div>

                <div class="row" style="padding-top: 20px">
                    <div class="col-md-10 col-md-offset-1" style="text-align: left">
                        <div class="btn btn-default" id="next1"> next </div>
                    </div>
                </div>


           </div>
        </div>


        <div class="col-md-5 panel panel-default" id="questionDivs" style="display: none">
            <div class="panel-body">
                <div class="col-md-12" id="infodiv">
                    <ul class="list-group">
                        <!--<li class="list-group-item preclass" style="display: none">-->
                            <!--<div class="preclass">-->
                                <!--<span class="">previously:</span>-->
                                <!--<span class="" id="preword"></span>-->
                                <!--<span class="" id="prechinese"></span>-->
                            <!--</div>-->
                        <!--</li>-->

                        <li class="list-group-item" >
                            <span class="lilabel "></span>
                            <span class="" id="english" class="">Jupiter</span>
                            <span id="play" class="glyphicon glyphicon-volume-down"></span>
                        </li>
                        <li class="list-group-item"  id="qpic" style="display:none">
                            <a href="#" class="thumbnail"><img src="" /></a>
                        </li>
                        <li class="list-group-item "><span class="lilabel"></span><span class="" id="wiki">Jupiter is the largest planet in solar system.</span></li>
                        <li class="list-group-item shouldhide" ><span class="lilabel "></span> <span class="" id="chinese">木星</span></li>
                        <li class="list-group-item " id="next"><span class="btn btn-default" >next</span></li>
                    </ul>
                </div>

                <div class="col-md-12 picsection" id="picsection">
                    <div class="col-md-6 image"><a href="#" class="thumbnail"><img src="" id="pic1"/></a></div>
                    <div class="col-md-6  image"><a href="#" class="thumbnail"><img src="" id="pic2"/></a></div>
                    <!--<div class="col-md-6  image"><a href="#" class="thumbnail"><img src="" id="pic3" /></a></div>-->
                    <!--<div class="col-md-6  image"><a href="#" class="thumbnail"><img src="" id="pic4"/></a></div>-->
                </div>

                <div class="col-md-12 answersection" style="display: none">
                    <ul class="list-group">
                        <li class="list-group-item ">
                            <div id="word0" class="">haha</div>
                                <img src="">
                        </li>
                        <li class="list-group-item ">
                            <div id="word1">haha</div>

                                <img src="">

                        </li>
                        <li class="list-group-item ">
                            <div id="word2" class="">haha</div>

                                <img src="">
                        </li>
                        <li class="list-group-item">
                            <div id="word3" class="">haha</div>
                                <img src="">
                        </li>

                    </ul>
                </div>
            </div>
        <!--</div>-->
      </div>
  </div>
  <div class="col-md-12">
      <div id="legend">
      </div>
  </div>
</div>

<div style="position: fixed; min-width:800px; z-index:999; left: 320px; top: 5px; display: none" id="show_tip_div">
    <div class="alert alert-info" style="background: #d1d1d1;font-size: 20px; filter:alpha(opacity=80);-moz-opacity:0.8;opacity:0.8;"> <span id="show_tip">hahahah</span></div>
</div>
</body>
</html>

<script>

    function playaudio(audioname) {
        //var paused = $('#jquery_jplayer_1').data().jPlayer.status.paused;
        //if (paused == true)
        $("#jquery_jplayer_1").jPlayer("setMedia", {
            title: "Bubble",
            mp3: audioname
        }).jPlayer("play"); //在页面load播放的时候自动播放
    }

    function loadaudio(audioname) {
        $("#jquery_jplayer_1").jPlayer({
            ready: function() {
                $(this).jPlayer("setMedia", {
                    title: "Bubble"
                }).jPlayer("play"); //在页面load播放的时候自动播放

            },
            swfPath: "/js/jplayer",
            supplied: "mp3",
            wmode: "window",
            smoothPlayBar: true,
            keyEnabled: true,
            remainingDuration: true,
            toggleDuration: true
        });
    }

    loadaudio("");
</script>

<script>
    /**
     * layer is the layer of
     */
    function Drawable(layer,x,y,width,height,key)
    {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.layer = layer;
        this.key = key;
        this.pic = null;
        this.bg = null;
        this.word = null;
        this.wiki = null;
        this.chinese = null;
        this.voice = null;
    }

    Drawable.prototype = {
        drawbg1:function()
        {
            if(this.bg == null)
            {
                var img = new Image();
                img.src = "picture/nemo1/selected2.png";
                var bg = new LBitmap(new LBitmapData(img));
                bg.x = this.x;
                bg.y = this.y;
                this.bg = bg;
                this.layer.addChild(this.bg);
            }
        }
        ,
        drawbg:function()
        {
            if(this.bg == null)
            {
                var img = new Image();
                img.src = "picture/nemo1/bg.png";
                var bg = new LBitmap(new LBitmapData(img));
                bg.x = this.x;
                bg.y = this.y;
                this.bg = bg;
                this.layer.addChild(this.bg);
            }
        }
        ,
        drawdata:function()
        {
            var span = 30;
            var q = map[this.key];
            if (this.pic == null)
            {
                // picture
                var img = new Image();
                img.src = imagUrlPre+ q.picmd;
                var pic = new LBitmap(new LBitmapData(img));

                var picWidth = pic.getWidth();
                var picHeight = pic.getHeight();

                pic.scaleX = 98/picWidth
                pic.scaleY = 98/picHeight;

                span = (this.width - pic.getWidth()) / 2;
                pic.x = this.x + span;
                pic.y = this.y + span;
                this.pic = pic;
                this.layer.addChild(this.pic);
            }

            // word
            //var q = map[this.key];
            if(this.word == null) {
                var textfield = new LTextField();
                this.word = textfield;
                this.word.width = this.bg.getWidth()*5/6;
                if(this.word.width < 10)
                    this.word.width =82;

                this.word.setWordWrap(true);
                this.word.size = 12;
                this.word.color="#3c3c3c";
                this.word.text = breakSendence(q.word,14);
                this.word.x = this.x + span;
                this.word.y = this.y + span + this.pic.getHeight()+5;
                this.layer.addChild(textfield);
            }

            // chinese
            //var q = map[this.key];
            if(this.chinese == null) {
                var textfield = new LTextField();
                this.chinese = textfield;
                this.chinese.size = 10;
                this.chinese.color="#3c3c3c";
                this.chinese.text = q.chinese;
                this.chinese.x = this.x + span+2 ;
                this.chinese.y = this.y + span + this.pic.getHeight()+this.word.getHeight()+10;
                this.layer.addChild(textfield);
            }
        }
        ,
        draw:function() {
            // this.layer.graphics.drawRect(1,"#000000",[this.x,this.y,this.width,this.height]);
            // background picture
            this.clear();
            this.drawbg();
            this.drawdata();

        },

        heart:function()
        {
            var hx = this.x + this.width/2;
            var hy = this.y + this.height/2;

            return [hx,hy];
        },

        within:function(px,py)
        {
            if(px <= this.x+this.width && px >= this.x && py <= this.y+this.height && py >= this.y)
            {
                return true;
            }
            return false;
        }
        ,clear:function()
        {
            if(this.pic != null)
                this.layer.removeChild(this.pic);
            if(this.bg != null)
                this.layer.removeChild(this.bg);
            if(this.word != null)
                this.layer.removeChild(this.word);
            if(this.word != null)
                this.layer.removeChild(this.chinese);
            this.pic = null;
            this.bg = null;
            this.word = null;
            this.chinese = null;
        }
    }
</script>

<script>
    /**
     * layer is the layer of
     */
    function LDrawable(layer,x,y,width,height,key)
    {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.layer = layer;
        this.key = key;
        this.pic = null;
        this.bg = null;
        this.word = null;
        this.word1 = null;
        this.wiki = null;
        this.chinese = null;
        this.voice = null;
    }

    LDrawable.prototype = {
        drawbg:function()
        {
            if(this.bg == null)
            {
                var img = new Image();
                img.src = "picture/nemo1/selected.png";
                var bg = new LBitmap(new LBitmapData(img));
                bg.x = this.x;
                bg.y = this.y;
                this.bg = bg;
                this.layer.addChild(this.bg);
            }
        }
        ,
       changebghover:function()
       {
           if(this.bg != null)
           {
               var img = new Image();
               img.src = "picture/nemo1/hover.png";
               var hover = new LBitmapData(img);
               this.bg.bitmapData = hover;

           }
       }
        ,
        changebgnormal:function()
        {
            if(this.bg != null)
            {
                var img = new Image();
                img.src = "picture/nemo1/selected.png";
                var normal = new LBitmapData(img);
                this.bg.bitmapData = normal;

            }
        }

        ,
        drawdata:function()
        {
            var span = 4;
            var q = map[this.key];
            if (this.pic == null)
            {
                // picture
                var img = new Image();
                img.src = imagUrlPre+ q.picsm;
                var pic = new LBitmap(new LBitmapData(img));
                span = (this.height-pic.getHeight()) / 2;
                pic.x = this.x + span;
                pic.y = this.y + span;
                this.pic = pic;
                this.layer.addChild(this.pic);
            }

            // word
            //var q = map[this.key];
            if(this.word == null) {
                var textfield = new LTextField();
                this.word = textfield;
                this.word.text = q.chinese;
                this.word.x = this.x + span+this.pic.getWidth()+10;
                this.word.y = this.y + span/2;
                this.layer.addChild(this.word);
            }

            // word
            //var q = map[this.key];
            if(this.word1 == null) {
                var textfield = new LTextField();

                this.word1 = textfield;
                this.word1.size =12;
                this.word1.color = "#3c3c3c";
                this.word1.text = q.word;
                this.word1.x = this.x + span+this.pic.getWidth()+10;
                this.word1.y = this.y + span/2+20;
                this.layer.addChild(this.word1);
            }
        }
        ,
        draw:function() {
            // this.layer.graphics.drawRect(1,"#000000",[this.x,this.y,this.width,this.height]);
            // background picture
            this.drawbg();
            this.drawdata();

        },

        heart:function()
        {
            var hx = this.x + this.width/2;
            var hy = this.y + this.height/2;

            return [hx,hy];
        },

        within:function(px,py)
        {
            if(px <= this.x+this.width && px >= this.x && py <= this.y+this.height && py >= this.y)
            {
                return true;
            }
            return false;
        },

        clear:function()
        {
            if(this.pic != null)
                this.layer.removeChild(this.pic);
            if(this.bg != null)
                this.layer.removeChild(this.bg);
            if(this.word != null)
                this.layer.removeChild(this.word);
            if(this.word1 != null)
                this.layer.removeChild(this.word1);


            this.pic = null;
            this.bg = null;
            this.word = null;
            this.word1 = null;
        }
    }
</script>

<script>

    function getNodes(pairs)
    {
        var nodes = [];

        for(var i = 0; i < pairs.length; i++)
        {
            var r = pairs[i];
            if(nodes.indexOf(r[0]) < 0)
                nodes.push(r[0]);
            if(nodes.indexOf(r[1]) < 0)
                nodes.push(r[1]);
        }

        return nodes;
    }
    function getHierarchy(pairs,root)
    {
        var nodes = getNodes(pairs);
        var layers = [];
        layers.push([root]);
        var nodecount = 1;
        var layercount = 0;
        while(nodecount <= nodes.length)
        {
            var prelayer = layers[layercount];

            var currentlayer = [];
            for(var i = 0; i < prelayer.length; i++)
            {
                var tmp = prelayer[i];
                var children = findChildren(pairs,tmp);
                addArray2Array(children, currentlayer);
                nodecount+=children.length;

            }

            layers.push(currentlayer);

            if(layercount>10)
                break;
            layercount+=1;
        }
        return layers;

    }


    function renderTree(pairs,hs,layer)
    {
        drawableMap = {};
        var count = 1;
        for(var i = 0; i < hs.length; i++)
        {
            var h = hs[i];
            for(var j = 0; j < h.length; j++)
            {
               // var d = new Drawable(layer, i*(bgwidth+bgwidth)+10,j*(bgheight+bgheight/4)+10,bgwidth,bgheight,h[j]);
                var d = new Drawable(layer,j*(bgheight+bgheight/4)+50, i*(bgwidth+bgwidth)+10, bgwidth,bgheight,h[j]);
                d.drawbg();
                drawableMap[h[j]] = d;
                count++;
            }
        }

        return drawableMap;
    }

    /**
     * find children of elem
     * @param pair
     * @param elem
     */
    function findChildren(pairs,elem)
    {
        var children = [];
        for(var i = 0; i < pairs.length; i++)
        {
            var pair = pairs[i];
            if(pair[0] == elem)
                children.push(pair[1])
        }

        return children;
    }

    function addArray2Array(array1,array2)
    {
        if (array1 == null || array1.length == 0)
            return ;

        for(var i = 0; i < array1.length; i++)
        {
            if(array2.indexOf(array1[i]) < 0)
            {
                array2.push(array1[i]);
            }
        }
    }

    /**
     * 用线将将两个drawable连起来，横着排
     * @param d1
     * @param d2
     */
    function link2drawable(layer,d1,d2)
    {
        if(d1 == null || d2 == null)
            return ;
        var p1heart = d1.heart();
        var p2heart = d2.heart();

        p1x = p1heart[0]+d1.width/2;
        p1y = p1heart[1];

        p2x = p2heart[0]-d2.width/2;
        p2y = p2heart[1];

        p3x = p1x+(p2x - p1x)/2;

        layer.graphics.drawLine(0.5,"#7ecefd",[p1x,p1y,p3x,p1y]);
        layer.graphics.drawLine(0.5,"#7ecefd",[p3x,p1y,p3x,p2y]);
        layer.graphics.drawLine(0.5,"#7ecefd",[p3x,p2y,p2x,p2y]);
        return [p3x,(p1y+p2y)/2]
    }

    /**
     * 用线将将两个drawable连起来 竖着排。
     * @param d1
     * @param d2
     */
    function link2drawable1(layer,d1,d2)
    {
        if(d1 == null || d2 == null)
            return ;
        var p1heart = d1.heart();
        var p2heart = d2.heart();

        p1x = p1heart[0];
        p1y = p1heart[1]+d1.height/2;

        p2x = p2heart[0]
        p2y = p2heart[1]-d2.height/2;

       // p3x = p1x+(p2x - p1x)/2;

        p3y = p1y+(p2y-p1y)/2;

//        layer.graphics.drawLine(0.5,"#7ecefd",[p1x,p1y,p1x,p3y]);
//        layer.graphics.drawLine(0.5,"#7ecefd",[p1x,p3y,p2x,p3y]);
//        layer.graphics.drawLine(0.5,"#7ecefd",[p2x,p3y,p2x,p2y]);
          layer.graphics.drawLine(0.5,"#7ecefd",[p1x,p1y,p2x,p2y]);

        return [(p1x+p2x)/2,p3y]
    }
//    /**
//     * 用线将将两个drawable连起来。
//     * @param d1
//     * @param d2
//     */
//    function link2drawable1(layer,d1,d2)
//    {
//        if(d1 == null || d2 == null)
//            return ;
//        var p1heart = d1.heart();
//        var p2heart = d2.heart();
//
//        p1x = p1heart[0]+d1.width/2;
//        p1y = p1heart[1];
//
//        p2x = p2heart[0]-d2.width/2;
//        p2y = p2heart[1];
//
//        p3x = p1x+(p2x - p1x)/2;
//
//        layer.graphics.drawLine(0.5,"#7ecefd",[p1x,p1y,p3x,p1y]);
//        layer.graphics.drawLine(0.5,"#7ecefd",[p3x,p1y,p3x,p2y]);
//        layer.graphics.drawLine(0.5,"#7ecefd",[p3x,p2y,p2x,p2y]);
//
//        return [p3x,(p1y+p2y)/2]
//    }

    function linkTree(layer,drawablemap,nodes,pairs)
    {
        for(var i = 0; i < nodes.length; i++)
        {
            var node = nodes[i];
            var drawable1 = drawablemap[node];
            var children = findChildren(pairs,node);
            for(var j = 0; j < children.length; j++)
            {
                var cnode = children[j];
                var drawable2 = drawablemap[cnode];
                link2drawable1(layer,drawable1,drawable2);
            }
        }
    }

</script>

<script>
    var pairs =[
        ["Bigbang","Universe","What does big bang create?"],
        ["Universe","Galaxy","What is made of millions of stars,gas and dust?"],
        ["Galaxy","Elliptical galaxy","What galaxy is oval in shape?"],
        ["Galaxy","Spiral galaxy","What galaxy is shaped like a giant whirlpool?"],
        ["Spiral galaxy","Andromeda galaxy","Which galaxy is the largest spiral galaxy?"],
        ["Spiral galaxy","Milky Way galaxy","Which galaxy looks like a band of light observed from earth?"],
        ["Milky Way galaxy","Solar system","What is made up of the sun surrounded by planets and other objects?"],
        ["Milky Way galaxy","Star","What can give off heat and light in the galaxy?"]
    ];

    //节点之间的线 关系
    var relationship = {};

</script>




<script>

var map = {
    "Bigbang": {
        word: "Bigbang",
        audio:"/audio/bigbang.mp3",
        pic: "U11.jpg",
        picmd: "U11md.jpg",
        picsm: "U11sm.jpg",
        wiki: "The universe began with an explosion, the explosion is called the big bang.",
        chinese: "宇宙大爆炸"
    },
    "Universe": {
        word: "Universe",
        audio:"/audio/universe.mp3",
        pic: "U21.jpg",
        picmd: "U21md.jpg",
        picsm: "U21sm.jpg",
        wiki: "The Universe contains earth, planets, stars and everything else in outer space. ",
        chinese: "宇宙"
    },
    "Galaxy": {
        word: "Galaxy",
        audio:"/audio/galaxy.mp3",
        pic: "U31.jpg",
        picmd: "U31md.jpg",
        picsm: "U31sm.jpg",
        wiki: "A galaxy is made up of billions of stars, gas and dust.",
        chinese: "星系"
    },
    "Elliptical galaxy": {
        word: "Elliptical galaxy",
        audio:"/audio/elliptical_galaxy.mp3",
        pic: "U41.jpg",
        picmd: "U41md.jpg",
        picsm: "U41sm.jpg",
        wiki: "An elliptical galaxy is oval or round in shape.",
        chinese: "椭圆星系"
    },
    "Spiral galaxy": {
        word: "Spiral galaxy",
        audio:"/audio/spiral_galaxy.mp3",
        pic: "U51.jpg",
        picmd: "U51md.jpg",
        picsm: "U51sm.jpg",
        wiki: "A spiral galaxy is shaped like a giant whirlpool or pinwheel.",
        chinese: "螺旋星系"
    },
    "Andromeda galaxy": {
        word: "Andromeda galaxy",
        audio:"/audio/andromeda_galaxy.mp3",
        pic: "U61.jpg",
        picmd: "U61md.jpg",
        picsm: "U61sm.jpg",
        wiki: "Andromeda galaxy is a large spiral galaxy.",//，it is indicated to collide with Milky Way galaxy to form an elliptical galaxy
        chinese: "仙女座星系"
    },
    "Milky Way galaxy": {
        word: "Milky Way galaxy",
        audio:"/audio/milky_way_galaxy.mp3",
        pic: "U71.jpg",
        picmd: "U71md.jpg",
        picsm: "U71sm.jpg",
        wiki: "Milky Way galaxy is a spiral galaxy, on earth, it looks like a band of light.",
        chinese: "银河系"
    },
    "Solar system": {
        word: "Solar system",
        audio:"/audio/solar_system.mp3",
        pic: "U81.jpg",
        picmd: "U81md.jpg",
        picsm: "U81sm.jpg",
        wiki: "The sun and surrounding planets make up the solar system. It's a place we called home in the Milk Way Galaxy.",
        chinese: "太阳系"
    },
    "Star": {
        word: "Star",
        audio:"/audio/star.mp3",
        pic: "U91.jpg",
        picmd: "U91md.jpg",
        picsm: "U91sm.jpg",
        wiki: "A star like our sun gives off light and heat.",
        chinese: "恒星"
    }
}

</script>




<script>
    var map = {};
    var pairs = new Array();
    var depends = null;
    function parse(json)
    {

        map = {};
        pairs = new Array();
        depends = null;

        for(var i = 0; i < json.length; i++) {
            var obj = json[i];
            var word = trim(obj['subkey']);

            map[word] = {};
            map[word]["word"] = word;

            var item = getTaskResultByTaskName(obj["results"], "picture");
            var picture = null;
            if (item!=null && item != undefined && item["value"] != null && item["value"] != undefined)
                picture = item["value"]["image"][0];
            map[word]["pic"] = picture;
            map[word]["picsm"] = picture;
            map[word]["picmd"] = picture;

            var item = getTaskResultByTaskName(obj["results"], "wiki");
            var wiki = null;
            if (item!=null && item != undefined && item["value"] != null && item["value"] != undefined)
                wiki = item["value"]["text"][0];
            map[word]["wiki"] = wiki;

            var item = getTaskResultByTaskName(obj["results"], "chinesetranslation");
            var chinesetranslation = null;
            if (item!=null && item != undefined && item["value"] != null && item["value"] != undefined)
                chinesetranslation = item["value"]["text"][0];
            map[word]["chinese"] = chinesetranslation;

            var item = getTaskResultByTaskName(obj["results"], "tips");
            var tips = null;
            if (item!=null && item != undefined && item["value"] != null && item["value"] != undefined)
                tips = item["value"]["text"][0];
            map[word]["tips"] = tips;

            var item = getTaskResultByTaskName(obj["results"], "audio");
            var audio = null;
            if (item!=null && item != undefined && item["value"] != null && item["value"] != undefined)
                audio = item["value"]["audio"][0];
            map[word]["audio"] = audio;

            var item = getTaskResultByTaskName(obj["results"], "maps");
            var map_ = null;
            if (item!=null && item != undefined && item["value"] != null && item["value"] != undefined)
                map_ = item["value"]["text"][0];

            if (map_ != null && map_ != undefined && map_.length > 0) {
                depends = map_;
            }

        }

        pairs = convertDepends2Pairs(depends, map);

        return map;
    }

    function convertDepends2Pairs(depends,wordsmap)
    {
        var singleDepends = depends.split("#");
        var ret = new Array;
        for(var i = 0; i < singleDepends.length; i++)
        {
            var pair = singleDepends[i];
            if(pair == "" || pair == null || pair == undefined)
                continue;

            var words = pair.split("=");
            var word = wordsmap[words[1]];
            var tmp = [words[0], words[1], "empty tips"];
            if(word != null && word != undefined && word['tips'] != null && word['tips'] != undefined )
                var tmp = [words[0], words[1], word['tips']];
            ret.push(tmp);
        }

        return ret;
    }


    function getTaskResultByTaskName(items, taskName)
    {
        for(var i = 0; i < items.length; i++)
        {
            var item = items[i];
            if(item["taskName"] == taskName)
                return item;
        }
    }

</script>

<script>
    var bgwidth = 124;
    var bgheight = 182;

    var treeLayer;
    var leftLayer;
    var bglayer; //背景层；
    var usertipslayer;
    var loadingLayer ;//图片加载层

    //提示层
    var bubblelayer;
    var bubbleText = null;

    //存放的是tree drawable
    var larray= new Array();
    //left的LDrawable
    var lmap = {};
    // tree的Drawable
    var dmap = {};
    var bubbleHalfWidth= 103;
    var bubbleHeight = 98;


    var larraytmp = new Array();

    //当前是哪一个了
    window.index = 0;
    window.right = 0;
    window.lastDrawable = null;
    var interuptLimit = 2;

    function showInterupt(key)
    {
        //larraytmp = new Array();

        var count = 0;

        var addArray = new Array();

        for(var i = 0; i < larray.length;i++)
        {
            var ld = larray[i];
            if (ld.key == key) {
                continue;
            }
            else
            {
                ld.clear();
            }
        }


        for(var i = 0; i < larray.length;i++)
        {
            var ld = larray[i];
            if(ld.key == key)
            {
                continue;
            }

            if(Math.random() > 0.6)
            {
                //ld.draw();
                count += 1;
                addArray.push(i);
            }

            if(count > interuptLimit)
                return addArray;
        }


            while(addArray.length < 3)
            {
                var random = Math.floor(Math.random()*100) % (larray.length);
                var ld = larray[random];
                if(addArray.indexOf(random) < 0 && ld.key != key)
                {
                    addArray.push(random);
                    //ld.draw();
                }
            }
        return addArray;
    }

    function initTree(root)
    {
        treeLayer = new LSprite();

        treeLayer.x = 256;
        treeLayer.y = 20;

        addChild(treeLayer);

        var nodes = getNodes(pairs);
        var hs = getHierarchy(pairs,root);
       // alert(hs);
        dmap = renderTree(pairs,hs,treeLayer);
        //linkTree(treeLayer,dmap,nodes,pairs);
        treeLayer.addEventListener(LMouseEvent.MOUSE_UP,onclick);
    }

//
//    function onclick(event)
//    {
//        //alert(event.offsetX);
//        var img = new Image();
//        img.src = "picture/nemo1/bg.png";
//        var bitmapdaga = new LBitmapData(img);
//        dmap["A"].bg.bitmapData = bitmapdaga;
//    }


    function initLeft()
    {
        leftLayer = new LSprite();
        leftLayer.x = 10;
        addChild(leftLayer);

        var height = 50;
        var y = 50;
        for(var key in map)
        {
            var ld = new LDrawable(leftLayer, 10,y,190,height,key);
            //ld.draw();
            lmap[key] = ld;
            larray.push(ld);
            y+=height*1.5;
        }

        prepare();

        leftLayer.addEventListener(LMouseEvent.MOUSE_UP,onclickl);
        leftLayer.addEventListener(LMouseEvent.MOUSE_MOVE,hover);

    }

    /**
     * 从单词找到在map中的位置
     */
    function getIndexByWords(word)
    {
        for(var i = 0; i < getMapSize(map); i++)
        {
            var $question = getQuesion(i);
            if($question.word == word)
                return i;
        }

        return -1;
    }


    function show2beSelectedSmallCard(key)
    {
        var $lis = $("#sm_card_div_").find("li");
        // alert($lis.length);
        $lis.unbind("click");
        var rightIndex = getIndexByWords(key);
        $($lis[rightIndex]).on("click",function(){
            hideshow()
        });

        var addArray = showInterupt(key);
       // alert(addArray);
        addArray.push(rightIndex);

        var count = 0;
        for(var li in $lis)
        {
            if(addArray.contains(count))
            {
                $($lis[count]).show();
            }
            else
            {
                $($lis[count]).hide();
            }
            count+=1;
        }

    }

    function prepare()
    {


        //----------------
       // hideBubble();
        if(window.index >= pairs.length)
        {
            leftLayer.removeAllChild();
           // $("body").scrollLeft(250);

            showmodalPanel(step2ok);

            //show all small card
            var $lis = $("#sm_card_div_").find("li");
            for(var i = 0; i < getMapSize(map); i++)
            {
                $($lis[i]).show();
            }

            $("#show_tip_div").hide(500);

            window.qindex = 0;
            taskIndex += 1;
            var url = window.location.href;
            var search = window.location.search;
            $("body").children().remove();
            window.location.href = url.replace(search,"?taskIndex="+taskIndex);
            return;
        }

        var keys = pairs[window.index];

        //起始的图片的key
        var key = keys[0];
        //显示
        dmap[key].draw();

        //当前要显示为 十字架的 左边的图片
        var currentKey = keys[1];
        window.right = currentKey;
        var currentLd = lmap[currentKey];
        //currentLd.draw();//显示为待选

        showInterupt(currentLd.key);

        var lastTreeD = dmap[key];
        var currentTreeD = dmap[currentKey];
        window.lastDrawable = lastTreeD;
        //显示为十字架
        currentTreeD.clear();
        currentTreeD.drawbg1();

        var currentX = currentTreeD.x;
        var currentY = currentTreeD.y;

        if(currentX > 600 )
           $("body").scrollLeft(currentX-600);

        if(currentY > 400 )
           $("body").scrollTop(currentY-400);

        //用线连接起来
        var position = link2drawable1(treeLayer,lastTreeD,currentTreeD);

        //取得bubble的提示xinx
        var relationkey = lastTreeD.key+currentTreeD.key;
        var bubbletext = relationship[relationkey];

        //显示提示信息
        //showBubble(position[0]-bubbleHalfWidth,position[1]-bubbleHeight,bubbletext)

        show2beSelectedSmallCard(currentKey);

        $("#show_tip").text(bubbletext);
        window.index+=1;


    }



    //隐藏当前的，显示下一个个要选择的
    function hideshow()
    {

        // 上一个的keys
        var lastkeys = pairs[window.index-1];

        var lkey = lastkeys[1];

        var toshow = dmap[lkey];
        toshow.clear();
        toshow.draw();
        prepare();
    }

    /**
     * leftlayer function
     * @param event
     */
    function onclickl(event)
    {

        var x = event.offsetX;
        var y = event.offsetY;
        for(var i = 0; i < larray.length; i++)
        {

            var ld =  larray[i];
            if(ld.within(x,y) && ld.key == window.right)
            {
                  hideshow();
               // hideBubble();
            }
        }
        //setTimeout(function(){lds[0].drawbg();},1000);
    }


    function hover()
    {
        var x = event.offsetX;
        var y = event.offsetY;
        for(var i = 0; i < larray.length; i++)
        {

            var ld =  larray[i];
            if(ld.within(x,y))
            {
                ld.changebghover();
            }
            else
            {
                ld.changebgnormal();
            }
        }
    }

    function initBubbleLayer()
    {
        bubblelayer = new LSprite();
        addChild(bubblelayer);

        var img = new Image();
        img.src = "picture/nemo1/bubble.png";
        var bg = new LBitmap(new LBitmapData(img));
        bg.alpha = 1;
        bubblelayer.addChild(bg);

        bubbleText = new LTextField();
        bubbleText.color="#ffffff";
        bubbleText.size = 14;
        bubbleText.width = bg.getWidth()-20;
        bubbleText.setWordWrap(true);
        bubbleText.x = 5;
        bubbleText.y = 10;
        bubbleText.text = "bubble bubble";
        bubblelayer.addChild(bubbleText);
    }

    function hideBubble()
    {
        removeChild(bubblelayer);
    }

    function showBubble(x,y,text)
    {
        addChild(bubblelayer);
        bubblelayer.x = x+treeLayer.x;
        bubblelayer.y = y+treeLayer.y;
        bubbleText.text = text;
    }

    function initbglayer()
    {
        bglayer = new LSprite();
        addChild(bglayer);

        var img = new Image();
        img.src = backgroundpic;
        var bg = new LBitmap(new LBitmapData(img));
//        bg.scaleX=2;
//        bg.scaleY=2;
///        bg.alpha = 1;
        bglayer.addChild(bg);

    }

    function initusertipsLayer()
    {
        usertipslayer = new LSprite();
        addChild(usertipslayer);
    }


    var backgroundpic = "picture/nemo1/background.png";
    var images = new Array();

    function collectImageData()
    {
        var imgData = new Array();
        imgData.push({name:"background",path:backgroundpic});
        imgData.push({name:"bg",path:"picture/nemo1/bg.png"});
        imgData.push({name:"bubble",path:"picture/nemo1/bubble.png"});
        imgData.push({name:"hover",path:"picture/nemo1/hover.png"});
        imgData.push({name:"selected",path:"picture/nemo1/selected.png"});
        imgData.push({name:"selected2",path:"picture/nemo1/selected2.png"});

        imgData.push({name:"wrongpic",path:wrongpic});
        imgData.push({name:"rightpic",path:rightpic});

        imgData.push({name:"wrongpicsm",path:wrongpicsm});
        imgData.push({name:"rightpicsm",path:rightpicsm});

        images.push(backgroundpic);
        images.push( "picture/nemo1/bg.png");
        images.push("picture/nemo1/bubble.png");
        images.push("picture/nemo1/hover.png");
        images.push("picture/nemo1/selected.png");
        images.push("picture/nemo1/selected2.png");
        images.push(wrongpic);
        images.push(rightpic);
        images.push(wrongpicsm);
        images.push(rightpicsm);


//        for(var i = 1;i <=9; i++)
//            for(var j = 1; j <=4; j++)
//            {
//                imgData.push({name:"U"+i+""+j+".jpg",path:imagUrlPre+"U"+i+""+j+".jpg"});
//            }
        var count = 1;
        for(var key in map)
        {
           var item = map[key];
           imgData.push({name:item.word+"picmd",path:imagUrlPre+item.picmd});
           imgData.push({name:item.word+"picsm",path:imagUrlPre+item.picsm});
           images.push(imagUrlPre+item.picmd);
           images.push(imagUrlPre+item.picsm);
//
//           for(var j = 1; j <= 4; j++)
//           {
//               imgData.push({name:item.word+"U"+count+""+1,path:"picture/universe/U"+count+""+j+".jpg"});
//           }
//            count += 1;
        }

        return imgData;
    }


    function main1(){};
    function main()
    {
//        loadingLayer = new LoadingSample3();
//        addChild(loadingLayer);
//        var imgData = collectImageData();
//        /**
//         * LLoadManage.load($list,$onupdate,$oncomplete)
//         * $list表示尧都区的图片数组
//         * $onupdate表示读完一张图片后调用的函数，可以为空
//         * $oncomplete表示读完所有数组中图片后调用的函数
//         */
//        LLoadManage.load(
//                imgData,
//                function (progress) //每读取一张图片
//                {
//                    loadingLayer.setProgress(progress);
//                },
//                function(result)//所有图片加载完了
//                {
//                    //所有图片的Image对象
//                    removeChild(loadingLayer);
//                    loadingLayer = null;
//
//                }
//        );

        initall();
        $("#left").show(200);
//        setTimeout(function() {
//            playaudio("/audio/bigbang.mp3");
//        }, 100);
    }

    function breakSendence(sendence,limit)
    {
            var splits = sendence.split(/\s+/);
            var index = 0;
            var currentwords = "";
            var words = "";
            for(var i = 0; i < splits.length; i++)
            {
                var word = splits[i];
                if((currentwords.length + word.length+1) > limit)
                {
                    words += currentwords + "\n ";
                    currentwords = word;
                }
                else
                {
                    currentwords += " "+word;
                }
            }

        words += currentwords;
        return words;
    }

    function _renderAllSmallCard()
    {
        for(var i = 0; i < getMapSize(map); i++)
        {
            renderSmallCard(i);
        }
        var $sm_card_div = $("#sm-card-div");
        $sm_card_div_ = $sm_card_div.clone();
        $sm_card_div_.css("width","250px");
        $sm_card_div_.attr("id","sm_card_div_");
        $sm_card_div_.appendTo($("body"));

        $sm_card_div_.css("position","fixed");
        $sm_card_div_.css("z-index","999");
        $sm_card_div_.attr("class","");
        var offset = $sm_card_div.offset();
        offset.top = 20;
        offset.left = 2;
        $("li").on("mouseover",function(){
            $(this).css("background","#d1d1d1");
        }).on("mouseleave",function(){
            $(this).css("background","white");
        });


    }
    function initall()
    {
        //initbglayer();
        //initBubbleLayer();
       // initTree(treeRoot);
        //initLeft();
        //initusertipsLayer();
        $("#left").hide();
        //initbglayer();

    }

    //window.location.href = "http://www.baicizhan.com";

     $("li").on("mouseover",function(){
         $(this).css("background","#d1d1d1");
     }).on("mouseleave",function(){
         $(this).css("background","white");
     });


    function initRelationShip()
    {
        for(var i = 0; i < pairs.length; i++)
        {
            var pair = pairs[i];
            relationship[pair[0]+pair[1]] = pair[2];
        }
    }

    function startTask(ajaxurl)
    {
        $.ajax({
            type: "get",
            url: ajaxurl,
            dataType: 'text',
            jsonp: 'jsoncallback',
            success: function (data) {
                var json = eval("(" + data + ")");
                parse(json);

                collectImageData();
                preloadimages(images);

                treeRoot = pairs[0][0];
                initRelationShip();
                $("#loading").fadeOut();

                $("#left").show();
                $("#sm-card-div").children().show();
                $("#sm-card").children().remove();
                $("#sm_card_div_").children().remove();
                LInit(100, "legend", 2200, 1800, main);
                //$("#sm-card-div").css("height",$("window").height()-100);;

                $("#legend").hide();
                setTimeout(function () {
                    renderQuestion(0);
                }, 50);
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("ajax error");
            }
        });
    }

    //window.taskIndex = 0;
   // alert(taskIndex);
    collectImageData();
    preloadimages(images);
    setTimeout(function(){
      startTask(ajaxurls[taskIndex]);
    },
    3000);


   LInit(100, "legend", 2200, 1800, main);

</script>
<script>

    var test_name= "oneThing"; //区分不同的测试页面，需要和测试用户均分处定义一致
    var start_time = new Date();
    start_time = start_time.getTime();
    var cur_step = 0;
    var result = true;
    function submit_result(result)
    {
        // 当前的测试项目
        product = test_name;

        // 用户开始做题的时间作为 key ， 登陆用户后台会使用 userid 替换
        key = start_time.toString();

        // subkey 为用户提交的时间，可以用来区分同一用户的多次提交
        cur_time = new Date();
        cur_time = cur_time.getTime();
        subkey = cur_time.toString();

        // topic id 为 第一个数据 value_int_1
        topic_id = cur_step;
        value_int_1 = topic_id.toString();

        //数据位 value_int_2 表示该题目是否选择正确
        value_int_2 = result ? 1 : 0;

        json = '{"product":"'+product+'",';
        json += '"key":"'+key+'",';
        json += '"subkey":"'+subkey+'",';
        json += '"value_int_1":'+value_int_1+',';
        json += '"value_int_2":'+value_int_2+'}';

        $.post("http://lab.baicizhan.com/result/add_result",{"result":json},function(json, status)
        {
            json = $.parseJSON(json)
            if(json["RESP_CODE"] != "SUCCESS")
            {
                //alert("插入出错:"+json["RESP_CODE"]);
                return ;
            }
            else
            {
                //alert("插入成功:"+json["RESP_CODE"]);
                return ;
            }
        })
    }

    submit_result(true);
</script>
